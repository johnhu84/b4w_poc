b4w.register("victory_day_2015_main",function(fb,g){function gb(a,c){if(c){k=a;Fa.pause();hb();var b=ib.get_std_assets_path();jb.load(b+"victory_day_2015/main_scene.json",kb,lb);Ga();window.addEventListener("resize",Ga)}else console.log("b4w init failure")}function Y(a){if(q){var c=Z.get_coords_x(a);a=Z.get_coords_y(a);Ha(c,a);Ia(c,a)}}function O(){ma&&(ma=!1,na?(q=null,mb()):(C.pop(),C.pop(),d.remove_object(q),q=null,--t))}function mb(){var a=C[C.length-2],c=C[C.length-1],b=m.get_tsr(a,h.create()),
e=m.get_tsr(c,h.create()),R=h.transform_vec3(Ja,e,e);D.animate(0,1,500,function(e){var d=h.interpolate(b,R,I.smooth_step(e),h.create());m.set_tsr(a,d);1==e&&nb(a,c)})}function nb(a,c){var b=m.get_tsr(a,h.create()),e=m.get_tsr(c,h.create());Math.round(Math.random())?p.play_def(Ka):p.play_def(La);D.animate(0,1,500,function(d){var z=h.interpolate(b,e,I.smooth_step(d),h.create());m.set_tsr(a,z);1==d&&(k.addEventListener("mousedown",A),k.addEventListener("touchstart",A),S.append_stiff(a,c,x.set(0,0,0,
aa)),ba.set_nodemat_value(J,["control_box","Value"],1))})}function A(a){a.preventDefault&&a.preventDefault();var c=Z.get_coords_x(a);a=Z.get_coords_y(a);var b=d.pick_object(c,a);if(b)switch(d.get_object_name(b)){case "rockets_box":if(16!=t){t+=1;q=b=oa.copy(Ma,"rocket_"+t);C.push(b);var e="";10>t&&(e="0");pa=e=d.get_object_by_dupli_name("bm_13","rail_"+e+t);C.push(e);d.append_object(b);Ha(c,a);Ia(c,a);ma=!0}break;case "control_box_button":ca=2,ob()}}function ob(){t&&(k.removeEventListener("mousedown",
A),k.removeEventListener("touchstart",A),p.stop(qa),p.play_def(qa),b.apply(B,"press_button_Action"),b.set_behavior(B,b.AB_FINISH_STOP),b.play(B),b.set_speed(K,-1),b.play(K,function(){b.apply(n,"bm_13_Armature_rotate_-37_Action");b.set_first_frame(n);b.set_behavior(n,b.AB_FINISH_STOP);b.play(n,pb)}))}function pb(){var a=b.apply,c=b.play,f=b.set_behavior;a(l,T);b.set_frame(l,b.get_anim_start_frame(n));f(l,b.AB_FINISH_STOP);c(l,qb);a(J,"hide_control_box_Action");a(B,"hide_control_box_Action");f(J,b.AB_FINISH_STOP);
f(B,b.AB_FINISH_STOP);c(J);c(B);p.stop(U)}function qb(){for(var a=1;a<=t;a++)rb(a)}function rb(a){var c=d.append_object,f=S.append_stiff,e=b.apply,g=oa.copy,z=b.play,P=S.remove,V=d.remove_object,y=b.set_behavior,n=d.show_object,r="";10>a&&(r="0");var L=d.get_object_by_name("rocket_"+a),w=d.get_object_by_dupli_name("bm_13","rail_"+r+a);P(L);var q=g(Na,"rocket_flash_"+a),u=g(Oa,"rocket_plume_"+a),v=g(da,"rocket_start_smoke_"+a,!0),E=g(ea,"settling_smoke_"+a);D.set_timeout(function(){c(q);c(u);c(v);
c(E);n(v);n(E);e(q,"rocket_flash_Shader_NodetreeAction");e(u,"rocket_plume_start_Shader_NodetreeAction");e(v,"rocket_start_smoke_Shader_NodetreeAction");e(v,"rocket_start_smoke_finalscale",b.SLOT_1);e(E,"settling smoke_Shader_NodetreeAction");y(u,b.AB_FINISH_STOP);y(q,b.AB_FINISH_STOP);y(v,b.AB_FINISH_STOP);y(v,b.AB_FINISH_STOP,b.SLOT_1);y(E,b.AB_FINISH_STOP);y(M,b.AB_FINISH_STOP);y(N,b.AB_FINISH_STOP);f(q,L,ra);f(u,L,ra);f(v,w,sb);P(v);f(E,L,ra);z(q);z(v,function(){V(v)});var g=h.identity(h.create()),
R=h.identity(h.create());m.get_tsr(v,g);m.get_tsr(v,R);D.animate(0,.5,1E3,function(a){R[2]=g[2]-a;m.set_tsr(v,R)});D.set_timeout(function(){z(v,null,b.SLOT_1)},b.frame_to_sec(9));z(E,function(){P(E);V(E)});z(u,function(){e(u,"rocket_plume_loop__Shader_NodetreeAction");y(u,b.AB_CYCLIC);z(u)});D.set_timeout(function(){P(E)},100);p.play_def(sa);var r=m.get_tsr(L,h.identity(h.create())),x=h.create();h.copy(r,x);var B=h.transform_vec3(Pa,r,x);if(ta?0:a==(0>=t?1==t?1:t-1:t-0))ta=!0,e(M,"residual_smoke_Armature_Action"),
e(N,"residual_smoke_Shader_NodetreeAction"),e(F,"rocket_smoke_Shader_NodetreeAction"),e(F,"rocket_smoke_finalscale",b.SLOT_1),b.set_first_frame(M),b.set_first_frame(N),b.set_first_frame(F),b.set_first_frame(F,b.SLOT_1),y(M,b.AB_FINISH_STOP),y(N,b.AB_FINISH_STOP),y(F,b.AB_FINISH_STOP),y(F,b.AB_FINISH_STOP,b.SLOT_1),z(F),z(F,null,b.SLOT_1),D.set_timeout(function(){n(N);z(M);b.play(N,function(){ta=!1;m.set_tsr(l,Qa);var a=m.get_rotation(l,ua),a=Q.rotateX(a,Math.PI,Ra);m.set_rotation_v(l,a);a=d.hide_object;
a(fa);a(ga);a(va);b.apply(W,"9may_atlas_Shader_NodetreeAction");b.set_first_frame(W);b.set_behavior(W,b.AB_FINISH_STOP);p.stop(ha);p.play_def(ha);ia=0;for(a=2;a<=t+1;a++)tb(a)})},500);1==a&&wa.set_light_params(G,{light_energy:20});D.animate(0,1,2E3,function(c){var b=h.interpolate(r,B,I.smooth_step(c),h.identity(h.create()));m.set_tsr(L,b);m.set_translation(G,b[0],b[1],b[2]+8);1==c&&(P(q),P(u),V(L),V(q),V(u),a==t&&(C=[],p.stop(sa),k.addEventListener("mousedown",A),k.addEventListener("touchstart",A)))})},
250*a)}function Ha(a,c){var b=Sa.calc_ray(l,a,c,ub),e=Ta.get_pline_directional_vec(b,aa),b=m.get_translation(l,Ua),e=x.scale(e,3,xa),b=x.add(b,e,Va);b[2]=I.clamp(b[2],.5,3);m.set_translation_v(q,b)}function Ia(a,b){var f=m.get_translation(q,aa),e=m.get_rotation(q,ua),g=m.get_translation(pa,Ua),h=m.get_rotation(pa,Ra),d=Sa.project_point(l,g,xa),k=a-d[0],d=b-d[1],k=Math.sqrt(k*k+d*d);400>k?na=!0:(na=!1,k=400);d=I.quat_to_dir(e,I.AXIS_MZ,xa);f=x.subtract(f,g,Va);x.normalize(f,f);f=Q.rotationTo(d,f,vb);
Q.multiply(f,e,e);Q.normalize(e,e);e=Q.slerp(h,e,k/400,wb);m.set_rotation_v(q,e)}function ya(){var a=document.querySelector("#content"),b=document.querySelector("#info_container"),f=document.querySelector("#footer");ja>window.innerHeight+10?(ja-50>=window.innerHeight&&(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),440>window.innerHeight?(a.style.display="none",f.style.backgroundImage="",a.style.backgroundImage=""):(ja-50>=window.innerHeight&&
(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),a.style.display="",a.style.height=b.offsetHeight-200-175+"px"),380>window.innerWidth&&(a.style.height=parseInt(a.style.height)+70+"px")):(a.style.height="",f.style.backgroundImage="",a.style.backgroundImage="")}function kb(){var a=H.get_url_params();if(a&&"lang"in a){var c="ru";"ru"==a.lang&&(c="en");var a=document.querySelector("#social_buttons."+c),f=document.querySelector("#info."+c),
c=document.querySelector("#run_button."+c);a.parentNode.removeChild(a);f.parentNode.removeChild(f);c.parentNode.removeChild(c)}X=document.querySelector("#replay");za=X.querySelector("#replay_circle");w=document.querySelector("#info_container");ka=document.querySelector("#blend4web_logo");la=document.querySelector("#social_buttons");c=d.get_object_by_dupli_name;a=d.get_object_by_name;l=d.get_active_camera();W=c("9_may_logo","planes");fa=c("firework","firework_1");ga=c("firework","firework_2_1");va=
c("firework","firework_2_2");Ma=c("rocket","rocket");Wa=a("Empty_camera_position_2");U=c("red_square","noise_spk");qa=c("control_box","button_spk");Ka=c("bm_13","load_spk");La=c("bm_13","load_spk_2");n=c("bm_13","bm_13_Armature");ha=c("bg","fireworks_spk");J=c("control_box","control_box");B=c("control_box","control_box_button");sa=c("bm_13","shot_spk");Na=c("rocket_plume_flash","rocket_flash");Oa=c("rocket_plume_flash","rocket_plume");da=c("rocket_start_smoke","rocket_start_smoke");M=c("residual_smoke",
"residual_smoke_Armature");N=d.get_object_children(M)[0];ea=c("settling smoke","settling smoke");F=c("rocket_smoke","rocket_smoke");G=a("rocket_Point_1");Xa=a("bm_13");K=c("rockets_box","rockets_box_Armature");Ya=wa.get_light_params(G);c=m.get_tsr;a=x.set;c(l,Aa);c(fa,Ba);c(ga,Ca);Ca[3]=1;x.subtract(Ca,Ba,Da);c(Wa,Qa);a(0,0,-1.1,Ja);a(0,0,85,Pa);c(G,Za);c=d.get_object_by_name("control_box");f=h.multiply(h.invert(Aa,h.create()),m.get_tsr(c),h.create());a=Math.abs(f[2]);f=h.get_quat_view(f);S.append_stiff_viewport(c,
l,{right:0,bottom:0,distance:a,rotation:f});S.append_track(G,Xa);$a();b.apply(l,T);b.set_last_frame(l);window.addEventListener("resize",ya)}function $a(){T=window.innerWidth>window.innerHeight?"Camera_wide screen_Action":"Camera_narrow_screen_Action";l&&1==ca&&!b.is_play(l)&&b.apply(l,T)}function tb(a){var c=oa.copy,f=d.show_object,e=d.append_object,g=d.remove_object,h=b.apply,k=b.play,l=b.SLOT_1,r=m.set_tsr,q=c(fa,"firework_"+a,!0),p=c(ga,"firework_"+a+t+1,!0),n=c(va,"firework_"+a+t+2,!0);f(q);f(p);
f(n);var c=Math.floor(Math.random()*ab.length),c=ab[c],f=.4*-Math.random()+-.2,w=2*Math.random()+-1,x=.3*-Math.random()+0;ba.set_nodemat_rgb(p,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);ba.set_nodemat_rgb(n,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);c=bb(Ba,f,0,w,x,xb);f=bb(c,Da[0],-.03*a,Da[2],0,yb);r(q,c);r(p,f);r(n,f);var u=null;t==a-1&&(u=zb);D.set_timeout(function(){e(q);e(p);e(n);h(q,"firework_1_Shader_NodetreeAction");h(p,"firework_2_Action");h(p,"firework_2_Shader_NodetreeAction",
l);h(n,"firework_2_Action");h(n,"firework_2_Shader_NodetreeAction",l);k(q,function(){g(q)});k(n);k(p,function(){g(p)});k(n,function(){g(n);u&&u()},l)},ia);ia+=500*(.5+Math.random())}function zb(){p.stop(ha);b.play(W,Ab)}function Ab(){za.addEventListener("click",cb);var a=X.style;a.opacity=0;a.display="block";a=ka.style;a.opacity=0;a.display="block";a=la.style;a.opacity=0;a.display="block";H.css_animate(X,"opacity",0,1,1E3,"","",function(){H.css_animate(ka,"opacity",0,1,300);H.css_animate(la,"opacity",
0,1,500)});b.apply(n,"bm_13_Armature_rotate_-20_Action");b.set_behavior(n,b.AB_FINISH_STOP);b.set_first_frame(n)}function cb(){ka.style.display="";la.style.display="";X.style.display="";ba.set_nodemat_value(J,["control_box","Value"],0);b.set_first_frame(l);za.removeEventListener("click",cb);t=0;m.set_tsr(l,Aa);m.set_tsr(G,Za);wa.set_light_params(G,Ya);b.apply(l,T);b.set_first_frame(J);b.set_first_frame(B);p.play_def(U);ca=1;db()}function bb(a,b,f,e,g,d){h.identity(d);g=Q.setAxisAngle(I.AXIS_MY,g,
ua);b=x.set(b,f,e,aa);h.set_trans(b,d);h.set_quat(g,d);h.multiply(a,d,d);return d}function Ga(){Bb.resize_to_container();$a()}function lb(a){var b=r.querySelector("#preloader_line_left"),f=r.querySelector("#preloader_line_right"),e=r.querySelector("#percentage");100==a?Cb():(40>=a?b.style.width=2*a+"%":40<a&&60>a?b.style.width="100%":60<a&&(b.style.width="100%",f.style.width=2*(a-50)+"%"),e.innerHTML=a)}function hb(){r=document.querySelector("#preloader_container");var a=r.querySelector("#bg_image_container"),
b=r.querySelector("#bg_fade_container"),f=r.querySelector("#sun_container"),e=r.querySelector("#preloader"),d=H.css_animate;d(b,"opacity",0,.6,300);d(r,"opacity",0,1,300,"","",function(){d(a,"opacity",0,1,300,"","",function(){d(f,"opacity",0,1,300,"","",function(){d(e,"opacity",0,1,300,"","",function(){Fa.resume();main_canvas_container.style.visibility="visible"})})})})}function Cb(){Db();H.css_animate(r,"opacity",1,0,300,"","",function(){r.parentNode.removeChild(r)})}function Db(){var a=w.querySelector("#close_info_but"),
b=w.querySelector("#run_button"),f=w.querySelector("#info"),e=w.querySelector("#sound_cont");d.hide_object(da);d.hide_object(ea);a.addEventListener("click",eb);b.addEventListener("click",eb);e.addEventListener("click",Eb);w.style.display="block";f.style.display="block";b.style.display="block";document.querySelector("#content");ja=w.scrollHeight;ya()}function Eb(){var a=w.querySelector("#sound_cont");"active"==a.className?(a.className="",p.mute(null,!0)):(a.className="active",p.mute(null,!1))}function eb(){var a=
document.querySelector("#background_color");window.removeEventListener("resize",ya);d.hide_object(da);d.hide_object(ea);w.parentNode.removeChild(w);a.parentNode.removeChild(a);a=d.get_object_by_dupli_name("red_square","clock_spk");p.stop(a);p.stop(U);p.play_def(a);p.play_def(U);b.set_speed(l,-1);b.set_behavior(l,b.AB_FINISH_STOP);b.play(l,db)}function db(){b.apply(K,"opening_rockets_box_Action");b.set_first_frame(K);b.set_behavior(K,b.AB_FINISH_STOP);b.play(K,Fb)}function Fb(){b.apply(n,"bm_13_Armature_rotate_-20_Action");
b.set_first_frame(n);b.set_behavior(n,b.AB_FINISH_STOP);b.play(n,Gb)}function Gb(){k.removeEventListener("mousedown",A);k.removeEventListener("touchstart",A);k.removeEventListener("mousemove",Y);k.removeEventListener("touchmove",Y);k.removeEventListener("mouseup",O);k.removeEventListener("touchend",O);document.removeEventListener("mouseout",O);k.addEventListener("mousedown",A);k.addEventListener("touchstart",A);k.addEventListener("mousemove",Y);k.addEventListener("touchmove",Y);k.addEventListener("mouseup",
O);k.addEventListener("touchend",O);document.addEventListener("mouseout",O);ca=1}var b=g("animation"),H=g("app"),Sa=g("camera"),ib=g("config"),S=g("constraints"),Bb=g("container");g("controls");var jb=g("data"),wa=g("lights"),Fa=g("main"),ba=g("material"),Ta=g("math"),Z=g("mouse"),oa=g("objects"),d=g("scenes"),p=g("sfx"),D=g("time"),m=g("transform"),h=g("tsr"),I=g("util"),Hb=g("version"),Q=g("quat"),x=g("vec3"),Ea="DEBUG"===Hb.type(),C=[],ab=[[255,255,0],[255,0,148],[0,255,0],[0,0,255],[161,0,255],
[255,255,255],[94,255,255]],Aa=new Float32Array(8),Qa=new Float32Array(8),Ba=new Float32Array(8),Ca=new Float32Array(8),Za=new Float32Array(8),xb=new Float32Array(8),yb=new Float32Array(8),Da=new Float32Array(3),Ja=new Float32Array(3),Pa=new Float32Array(3),aa=new Float32Array(3),Ua=new Float32Array(3),xa=new Float32Array(3),Va=new Float32Array(3),ra=new Float32Array([0,0,0]),sb=new Float32Array([0,-1,0]);new Float32Array([0,0,-1.2]);var vb=new Float32Array(4),ua=new Float32Array(4),Ra=new Float32Array(4),
wb=new Float32Array(4),ub=Ta.create_pline(),W=null,Xa=null,n=null,qa=null,k=null,l=null,Wa=null,J=null,B=null,q=null,pa=null,fa=null,ga=null,va=null,ha=null,G=null,Ka=null,La=null,U=null,Ma=null,M=null,N=null,Na=null,Oa=null,F=null,da=null,K=null,ea=null,sa=null,ka=null,w=null,X=null,za=null,la=null,ja=0,r=null,na=!1,ma=!1,ta=!1,T="",ca=0,ia=0,t=0,Ya=null;fb.init=function(){var a=Ea,b=H.get_url_params();b&&"show_fps"in b&&(a=!0);H.init({canvas_container_id:"main_canvas_container",callback:gb,alpha:!1,
report_init_failure:!0,console_verbose:!0,assets_dds_available:!Ea,assets_min50_available:!Ea,show_fps:a})}});b4w.require("victory_day_2015_main").init();
