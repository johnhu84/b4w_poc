if(b4w.module_check("game_config"))throw"Failed to register module: game_config";
b4w.register("game_config",function(a,b){a.DEFAULT_POS=new Float32Array([0,0,-4]);a.LEVEL_LOAD_DELAY=1.5;a.GEM_OFFSET=new Float32Array([0,0,1]);a.GEM_ROT_OFFSET=new Float32Array([0,0,0,1]);a.GEM_SCALE_OFFSET=.6;a.GM_SPARE=0;a.GM_CARRIED=1;a.GM_LAYING=2;a.SHUTTER_EMITTER_EMPTY="shutter_glass";a.SHUTTER_EMITTER_NAME="glass_shutter_emitter";a.CL_BLUE=0;a.CL_PURPLE=1;a.CL_RED=2;a.CL_GREEN=3;a.CL_YELLOW=4;a.CL_MULTI=5;a.CHAR_EMPTY="petigor";a.CHAR_ARMAT="petigor_armature";a.CHAR_MODEL="petigor_model";
a.CHAR_PICKER="petigor_picker";a.CHAR_LIGHT="sword_light";a.CHAR_SPHERE="lava_shield_prot";a.CHAR_SWORD_SWITCHER="flaming_sword_switcher";a.MOUSE_ROT_MULT=2;a.TOUCH_ROT_MULT=.007;a.CAM_SOFTNESS=.2;a.CAM_OFFSET=new Float32Array([0,15,8]);a.CHAR_RAY_LENGTH=1.2;a.MAX_CHAR_HP=100;a.CHAR_ATTACK_DIST=2;a.CHAR_ATTACK_STR=35;a.CHAR_ATTACK_ANIM_FRAME=12;a.CH_STILL=0;a.CH_RUN=1;a.CH_ATTACK=2;a.CH_JUMP=3;a.CH_VICTORY=4;a.LAVA_DAMAGE_INTERVAL=.02;a.BONUS_SPAWN_CHANCE=.5;a.BONUS_HP_INCR=30;a.BONUS_SHIELD_TIME=
10;a.BONUS_SHIELD_EFFECT=.33;a.BONUS_LAVA_PROT_TIME=15;a.BONUS_LIFETIME=15;a.BONUS_FLASH_SPEED=3;a.BTYPE_HP=0;a.BTYPE_LAVA=1;a.BTYPE_SHIELD=2;a.CHAR_IDLE_ANIM="petigor_idle_combat";a.CHAR_RUN_ANIM="petigor_run";a.CHAR_STRAFE="petigor_strafe";a.CHAR_JUMP_ANIM="petigor_jump";a.CHAR_DEATH_ANIMS=["petigor_death_01","petigor_death_02"];a.CHAR_ATTACK_ANIMS=["petigor_atack_01","petigor_atack_02","petigor_atack_03"];a.CHAR_VICTORY_ANIM="petigor_victory";a.CHAR_HEAL_PICK_ANIM="heal_pick";a.CHAR_LAVA_PROT_ANIM=
"lava_prot_pick";a.CHAR_SHIELD_PICK_ANIM="shield_pick";a.SHIELD_FLASH_LENGTH=.9;a.LAVA_FALL_LENGTH=1;a.GOLEM_SPEED=.8;a.GOLEM_ROT_SPEED=1;a.GOLEM_ATTACK_DIST=2;a.GOLEM_ATTACK_STRENGTH=20;a.GOLEM_ATTACK_ANIM_FRAME=30;a.GOLEMS_SPAWN_INTERVAL=3;a.GOLEM_HP=100;a.STONE_GOLEMS_SP_MULT=1.5;a.GS_WALKING=0;a.GS_ATTACKING=1;a.GS_GETTING_OUT=2;a.GS_NONE=3;a.EN_TYPE_GOLEM_LAVA=0;a.EN_TYPE_GOLEM_STONE=1;a.GT_POINT=0;a.GT_CHAR=1;a.GT_OBELISK=2;a.GOLEM_LAVA_DEATH_EMPTY=["golem_lava_death"];a.GOLEM_DEATH_RIG=["golem_death_armature"];
a.GOLEM_DEATH_BLOW=["golem_death_blow"];a.STONE_GOLEM_EMITTER_EMPTY="golem_stone_getout";a.STONE_GOLEM_EMITTER=["golem_stone_getout","golem_stone_getout_emitter"];a.HP_BONUSES_EMPTIES=["potion_hp","potion_hp.001","potion_hp.002"];a.SHIELD_BONUSES_EMPTIES=["potion_def"];a.LAVA_BONUSES_EMPTIES=["potion_lava"];a.CAMERA_INDICTAOR=["camera_indicator","camera_indicator"];a.CAM_INDICATOR_VAL="mask_switcher";a.CHAR_RUN_SPEAKER="speaker_petigor_run";a.CHAR_WIN_SPEAKER="character_win_voice";a.CHAR_ATTACK_SPEAKER=
"speaker_petigor_sword_miss";a.CHAR_ATTACK_VOICE_SPKS=["speaker_petigor_voice_atack_01","speaker_petigor_voice_atack_02","speaker_petigor_voice_atack_03"];a.CHAR_HURT_SPKS=["speaker_petigor_voice_hurt_01","speaker_petigor_voice_hurt_02"];a.CHAR_JUMP_SPKS=["speaker_petigor_voice_jump_01","speaker_petigor_voice_jump_02"];a.CHAR_SWORD_SPEAKER="speaker_petigor_sword_hit";a.CHAR_DEATH_SPEAKER="speaker_petigor_voice_death_01";a.CHAR_LANDING_SPEAKER="speaker_petigor_jump_ends";a.GEM_PICKUP_SPEAKER="speaker_petigor_gem_pickup";
a.GEM_MOUNT_SPEAKER="speaker_petigor_gem_mount";a.CHAR_HEAL_SPEAKER="speaker_petigor_bonus_heal";a.CHAR_LAVA_SPEAKER="speaker_petigor_bonus_lava";a.CHAR_SHIELD_SPEAKER="speaker_petigor_bonus_shield";a.GOLEM_WALK_SPEAKER="golem_walk";a.GOLEM_ATTACK_SPEAKER="golem_atack_miss";a.GOLEM_HIT_SPEAKER="golem_atack_hit";a.GOLEM_GETOUT_SPEAKER="golem_getout";a.GEM_DESTR_SPEAKER="gem_destroy";a.WIN_SPEAKER="final_win"});if(b4w.module_check("obelisks"))throw"Failed to register module: obelisks";
b4w.register("obelisks",function(a,b){function C(a){switch(a){case "BG":return h.CL_BLUE;case "RG":return h.CL_RED;case "GG":return h.CL_GREEN;case "YG":return h.CL_YELLOW;case "PG":return h.CL_PURPLE}}function x(){for(var a=0;a<k.NUM_OBELISKS;a++){var e=k.ISLES_SHIELD_DUPLI_NAME_LIST;e[2]="island_shield_"+a;e=p.get_object_by_dupli_name_list(e);y.stop(e);y.set_behavior(e,y.AB_FINISH_STOP)}}function w(a,e){var b="obelisk_"+a,d=z[a];if(0<e){var l=k.OBELISKS_GEMS_NAME[a]+"_0"+(d.num_gems+1),b=p.get_object_by_dupli_name(b,
l);p.show_object(b);n.play_def(g);d.gem_health=k.OBELISK_GEM_HEALTH}else if(0>e){l=k.OBELISKS_GEMS_NAME[a]+"_0"+d.num_gems;b=p.get_object_by_dupli_name(b,l);p.hide_object(b);var l=G,h=v;c.get_translation(b,l);c.get_rotation(b,h);r(l,h)}d.num_gems+=e;F(a)}function F(a){if(t(a)&&("volcano"!=k.LEVEL_NAME||!A.island_has_enemies(a))){var e=z[a];if(k.ISLES_SHIELD_DUPLI_NAME_LIST){var b=k.ISLES_SHIELD_DUPLI_NAME_LIST;b[2]="island_shield_"+a;b=p.get_object_by_dupli_name_list(b);y.play(b);a=p.get_object_by_dupli_name("obelisk_"+
a,k.ISLAND_SPEAKER);n.play_def(a)}e.shine_obj&&(y.set_behavior(e.shine_obj,y.AB_FINISH_STOP),y.play(e.shine_obj));a:{for(e=0;e<k.NUM_OBELISKS;e++)if(!t(e)){e=!1;break a}e=!0}e&&m()}}function r(a,e){var b=p.get_object_by_dupli_name(h.SHUTTER_EMITTER_EMPTY,h.SHUTTER_EMITTER_NAME);c.set_translation_v(b,a);c.set_rotation_v(b,e);p.show_object(b);y.play(b,function(){p.hide_object(b)});var d=p.get_object_by_dupli_name(h.SHUTTER_EMITTER_EMPTY,h.GEM_DESTR_SPEAKER);n.play_def(d)}function m(){var a=p.get_object_by_name(h.WIN_SPEAKER);
n.play_def(a);n.clear_playlist();q.show_victory_element(1);if(k.STAIRS_OBJ){var b=p.get_object_by_name(k.STAIRS_OBJ,k.STAIRS_OBJ),a=p.get_object_by_dupli_name(k.STAIRS_OBJ,k.STAIRS_EMITTER),g=p.get_object_by_dupli_name(k.STAIRS_OBJ,k.STAIRS_MAGIC),d=p.get_object_by_dupli_name_list(k.ISLANDS_DOOR);p.show_object(a);y.apply(a,"dust");y.play(a);p.show_object(g);y.apply_def(g);y.set_behavior(g,y.AB_FINISH_STOP);y.play(g);setTimeout(function(){p.show_object(b);p.hide_object(d)},1E3)}else"dungeon"==k.LEVEL_NAME&&
(a=p.get_object_by_dupli_name("lava_death_controller","lava_death_controller"),y.set_behavior(a,y.AB_FINISH_STOP),y.play(a));e.run_victory()}function t(a){return z[a].num_gems==k.OBELISK_NUM_GEMS}function B(){for(var a=0;a<k.NUM_OBELISKS;a++){z[a].num_gems=0;for(var e=1;e<=k.OBELISK_NUM_GEMS;e++){var b=p.get_object_by_dupli_name("obelisk_"+a,k.OBELISKS_GEMS_NAME[a]+"_0"+e);b&&p.hide_object(b)}switch(k.LEVEL_NAME){case "volcano":e=k.ISLES_SHIELD_DUPLI_NAME_LIST;e[2]="island_shield_"+a;e=p.get_object_by_dupli_name_list(e);
y.set_frame(e,0);e=p.get_object_by_name(k.STAIRS_OBJ);b=p.get_object_by_dupli_name_list(k.ISLANDS_DOOR);p.show_object(b);p.hide_object(e);break;case "dungeon":e=p.get_object_by_dupli_name("level_02_enviroment",k.FLOOR_MAGIC_NAME),l.set_nodemat_value(e,["floor_magic_0"+(a+1),"Value"],0)}}}function u(a){for(var e=0;e<k.NUM_OBELISKS;e++)if(z[e].color==a)return e;return-1}var D=b("controls"),p=b("scenes"),y=b("animation"),n=b("sfx"),c=b("transform"),l=b("material");b("constraints");var h=b("game_config"),
e=b("character"),A=b("enemies");b("environment");var q=b("interface"),k=null,g=null,G=new Float32Array(3),v=new Float32Array(4),z=[];a.init=function(a,b){k=b;var c=e.get_wrapper();z.length=0;var d=function(a,b,d){1==d&&c.gem_slot&&a.num_gems!=k.OBELISK_NUM_GEMS&&(b=c.gem_slot.color,b==a.color||b==h.CL_MULTI)&&(e.remove_gem(),a=u(a.color),w(a,1))};k.ISLES_SHIELD_DUPLI_NAME_LIST&&x();if(k.FLOOR_MAGIC_NAME)var G=p.get_object_by_dupli_name("level_02_enviroment",k.FLOOR_MAGIC_NAME),A=function(a,e,b,d){b=
d.num_gems/k.OBELISK_NUM_GEMS;var g=d.magic_val;a=D.get_sensor_value(a,e,0);g!=b&&(g<b?d.magic_val+=.25*a:g>b&&(d.magic_val-=.25*a),l.set_nodemat_value(G,["floor_magic_0"+(d.id+1),"Value"],d.magic_val))};for(var q=0;q<k.NUM_OBELISKS;q++){var v="obelisk_"+q,n=p.get_object_by_dupli_name(v,"obelisk_collision"),r=k.OBELISKS_GEMS_NAME[q],m={num_gems:0,gem_health:0,color:C(r),id:q,magic_val:0,shine_obj:null},n=D.create_collision_sensor(n,"CHARACTER");D.create_sensor_manifold(m,"FILL_OBELISK_"+r,D.CT_TRIGGER,
[n],null,d);k.FLOOR_MAGIC_NAME&&(l.set_nodemat_value(G,["floor_magic_0"+(q+1),"Value"],0),D.create_sensor_manifold(G,"FLOOR_MAGIC"+q,D.CT_CONTINUOUS,[a],null,A,m));k.OBELISK_SHINE&&(v=p.get_object_by_dupli_name(v,k.OBELISK_SHINE+"_0"+(q+1)),m.shine_obj=v,y.apply_def(v));z.push(m)}g=p.get_object_by_dupli_name(h.CHAR_EMPTY,h.GEM_MOUNT_SPEAKER);B()};a.try_to_capture=F;a.is_filled=t;a.num_gems=function(a){return z[a].num_gems};a.damage_obelisk=function(a){--z[a].gem_health||(z[a].gem_health=k.OBELISK_GEM_HEALTH,
w(a,-1))};a.reset=B;a.get_id_by_color=u});if(b4w.module_check("gems"))throw"Failed to register module: gems";
b4w.register("gems",function(a,b){function C(a){if(a.state!=m.GM_SPARE)return!1;if(a.color==m.CL_MULTI)return!0;a=t.get_id_by_color(a.color);return!t.is_filled(a)}var x=b("controls"),w=b("scenes");b("sfx");var F=b("transform");b("util");var r=b("constraints");b("vec3");var m=b("game_config"),t=b("obelisks"),B=b("character"),u=null,D=null;a.init=function(a){D=a;u=[];a=function(a,b,c,k){1==c&&B.add_gem(k)};for(var b=0;b<D.GEMS_EMPTIES.length;b++){var n=D.GEMS_EMPTIES[b],c=D.GEMS_NAMES[b],l=w.get_object_by_name(n),
n=w.get_object_by_dupli_name(n,c);if(l&&n){switch(w.get_object_name(n)){case "gem_B":var h=m.CL_BLUE;break;case "gem_R":h=m.CL_RED;break;case "gem_G":h=m.CL_GREEN;break;case "gem_Y":h=m.CL_YELLOW;break;case "gem_P":h=m.CL_PURPLE;break;case "gem_M":h=m.CL_MULTI}l={empty:l,color:h,state:m.GM_SPARE};u.push(l);c=x.create_collision_sensor(n,"CHARACTER");x.create_sensor_manifold(n,"PICK_GEM",x.CT_TRIGGER,[c],null,a,l)}}};a.spawn=function(a){for(var b=0,n=0;n<u.length;n++)C(u[n])&&b++;if(b)for(b=Math.floor(b*
Math.random()),n=0;n<u.length;n++){var c=u[n];if(C(c)&&0==b--){F.set_translation_v(c.empty,a);c.state=m.GM_LAYING;break}}};a.reset=function(){for(var a=0;a<u.length;a++){var b=u[a],n=b.empty;r.remove(n);F.set_translation_v(n,m.DEFAULT_POS);b.state=m.GM_SPARE}}});if(b4w.module_check("interface"))throw"Failed to register module: interface";
b4w.register("interface",function(a,b){function C(a,b){function c(g,l,h){g=k-t.get_timeline();0>g?r.remove_sensor_manifold(null,"SHOW_"+a.id):a.style.opacity=1-g/b}a.style.visibility="visible";if(b){a.style.opacity=0;var k=t.get_timeline()+b;if(!r.check_sensor_manifold(null,"SHOW_"+a.id)){var g=r.create_elapsed_sensor();r.create_sensor_manifold(null,"SHOW_"+a.id,r.CT_CONTINUOUS,[g],null,c)}}else a.style.opacity=1}function x(a,b){function c(l,h,q){l=g-t.get_timeline();0>l?(a.style.visibility="hidden",
r.remove_sensor_manifold(null,"HIDE_"+a.id)):a.style.opacity=l/b*k}if(b){var k=a.style.opacity,g=t.get_timeline()+b;if(!r.check_sensor_manifold(null,"HIDE_"+a.id)){var l=r.create_elapsed_sensor();r.create_sensor_manifold(null,"HIDE_"+a.id,r.CT_CONTINUOUS,[l],null,c)}}else a.style.opacity=0,a.style.visibility="hidden"}var w=b("character"),F=b("game_config"),r=b("controls"),m=b("main"),t=b("time"),B=b("data"),u=b("config");b("mouse");var D=b("container"),p=u.get_std_assets_path()+"petigors_tale/",y=
null,n=null,c=null,l=null,h=null;a.init=function(b,A,q,k,g,G,v){function z(){m.resume();x(H,.5);x(ea);g()}function N(){C(V)}function u(a){a.preventDefault();a.stopPropagation();C(Z)}function E(){C(aa)}function d(){m.resume();B.unload();x(Y);x(ga);x(H);x(ea);x(F);x(da);x(f);x(R);C(S);ha.removeEventListener("mouseup",g);m.detect_mobile()?(document.getElementById("canvas3d").removeEventListener("touchstart",y),document.getElementById("control_jump").removeEventListener("touchstart",n),document.getElementById("control_attack").removeEventListener("touchstart",
c),document.getElementById("canvas3d").removeEventListener("touchmove",l),document.getElementById("canvas3d").removeEventListener("touchend",h),B.load(p+"intro_LQ.json",q,k,!0)):B.load(p+"intro_HQ.json",q,k,!0)}function w(){m.resume();x(H);x(ea);b(A);g()}function t(){x(K);x(W);b(A);g()}function M(){"visible"!=H.style.visibility&&(m.pause(),x(K),C(H),C(ea))}function J(a){a.stopPropagation();a.preventDefault();x(W);x(F);x(f);x(R);switch(G){case "level_01":v("level_02");break;case "level_02":v("under_construction")}}
var K=document.getElementById("replay"),F=document.getElementById("life_bar"),H=document.getElementById("game_menu"),O=document.getElementById("menu_resume"),I=document.getElementById("menu_help"),U=document.getElementById("menu_restart"),L=document.getElementById("menu_exit"),ba=document.getElementById("menu_credits"),R=document.getElementById("control_circle"),f=document.getElementById("controls"),da=document.getElementById("game_menu_calling"),T=document.getElementById("next_level"),W=document.getElementById("victory"),
V=document.getElementById("credits_panel"),Z=document.getElementById("authors_list"),ia=document.getElementById("authors_list_exit"),X=document.getElementById("authors_click_area"),aa=document.getElementById("help_panel"),S=document.getElementById("preloader_cont"),Y=document.getElementById("back_to_menu"),ga=document.getElementById("under_construct"),ea=document.getElementById("canvas_shadow"),ha=D.get_canvas();m.detect_mobile()?(O.addEventListener("touchstart",z,!1),I.addEventListener("touchstart",
E,!1),L.addEventListener("touchstart",d,!1),ba.addEventListener("touchstart",N,!1),X.addEventListener("touchstart",u,!1),U.addEventListener("touchstart",w,!1),K.addEventListener("touchstart",t,!1),W.addEventListener("touchstart",t,!1),V.addEventListener("touchstart",function(){x(V)},!1),ia.addEventListener("touchstart",function(){x(Z)},!1),aa.addEventListener("touchstart",function(){x(aa)},!1),T.addEventListener("touchstart",J,!1),aa.setAttribute("mobile","1"),Y.addEventListener("touchstart",d,!1),
da.addEventListener("touchstart",M,!1)):(O.addEventListener("click",z,!1),I.addEventListener("click",E,!1),L.addEventListener("click",d,!1),ba.addEventListener("click",N,!1),X.addEventListener("click",u,!1),U.addEventListener("click",w,!1),K.addEventListener("click",t,!1),W.addEventListener("click",t,!1),V.addEventListener("click",function(){x(V)},!1),ia.addEventListener("click",function(){x(Z)},!1),aa.addEventListener("click",function(){x(aa)},!1),T.addEventListener("click",J,!1),aa.setAttribute("mobile",
"0"),Y.addEventListener("click",d,!1),da.addEventListener("click",M,!1));"under_construction"==G?(Y=document.getElementById("back_to_menu"),ga=document.getElementById("under_construct"),C(Y),C(ga)):(C(F),m.detect_mobile()&&C(da),r.create_kb_sensor_manifold(null,"SHOW_MENU",r.CT_SHOT,r.KEY_ESC,M),a.update_hp_bar())};a.update_hp_bar=function(){var a=w.get_wrapper().hp,b=document.getElementById("life_bar_green"),c=document.getElementById("life_bar_red");document.getElementById("life_bar_mid");var k=
100/F.MAX_CHAR_HP,g=Math.max(a*k,0),a=Math.min((F.MAX_CHAR_HP-a)*k,100);b.style.width=g+"%";c.style.width=a+"%"};a.setup_touch_controls=function(a,b,q,k,g,G,v){function m(a){a.preventDefault();var b=window.innerWidth;a=a.changedTouches;for(var f=0;f<a.length;f++){var d=a[f],e=d.clientX,I=d.clientY;e>b/2?(B[0]=e,B[1]=I,J=d.identifier):(t[0]=e,t[1]=I,D=d.identifier,H.style.left=e-U+"px",H.style.top=I-U+"px",C(H),O.style.left=e-L+"px",O.style.top=I-L+"px",C(O))}}function p(a){a.preventDefault();a=a.changedTouches;
for(var b=0;b<a.length;b++){var f=a[b];r.set_custom_sensor(g,1);K=f.identifier}}function u(a){a.preventDefault();a=a.changedTouches;for(var b=0;b<a.length;b++){var f=a[b];r.set_custom_sensor(G,1);ca=f.identifier}}function w(d){d.preventDefault();r.set_custom_sensor(b,0);r.set_custom_sensor(k,0);r.set_custom_sensor(q,0);r.set_custom_sensor(a,0);var I=window.innerWidth;d=d.changedTouches;for(var f=0;f<d.length;f++){var g=d[f],c=g.clientX,l=g.clientY;if(c>I/2&&g.identifier==J){var L=B[0]-c,g=B[1]-l;
B[0]=c;B[1]=l;v(F.TOUCH_ROT_MULT*L,F.TOUCH_ROT_MULT*g)}else if(g.identifier==D){H.style.left=c-U+"px";H.style.top=l-U+"px";L=c-t[0];g=l-t[1];c=Math.sqrt(L*L+g*g);if(16>c)break;l=L/c;g=-g/c;l>Math.cos(3*Math.PI/8)?r.set_custom_sensor(a,1):l<-Math.cos(3*Math.PI/8)&&r.set_custom_sensor(q,1);g>Math.sin(Math.PI/8)?r.set_custom_sensor(b,1):g<-Math.sin(Math.PI/8)&&r.set_custom_sensor(k,1)}}}function d(d){d.preventDefault();d=d.changedTouches;for(var I=0;I<d.length;I++)d[I].identifier==D?(r.set_custom_sensor(b,
0),r.set_custom_sensor(k,0),r.set_custom_sensor(q,0),r.set_custom_sensor(a,0),x(H),x(O),D=null):d[I].identifier==J?J=null:d[I].identifier==K?(r.set_custom_sensor(g,0),K=null):d[I].identifier==ca&&(r.set_custom_sensor(G,0),ca=null)}var t=new Float32Array(2),B=new Float32Array(2),D,J,K,ca,H=document.getElementById("control_tap"),O=document.getElementById("control_circle"),I=document.getElementById("controls"),U=H.clientWidth/2,L=O.clientWidth/2;document.getElementById("canvas3d").addEventListener("touchstart",
m,!1);document.getElementById("control_jump").addEventListener("touchstart",p,!1);document.getElementById("control_attack").addEventListener("touchstart",u,!1);document.getElementById("canvas3d").addEventListener("touchmove",w,!1);document.getElementById("canvas3d").addEventListener("touchend",d,!1);I.addEventListener("touchend",d,!1);C(I);y=m;n=p;c=u;l=w;h=d};a.show_replay_button=function(a){var b=document.getElementById("replay");C(b,a)};a.hide_replay_button=function(a){var b=document.getElementById("replay");
x(b,a)};a.show_victory_element=function(a){var b=document.getElementById("victory");C(b,a)};a.hide_victory_element=function(a){var b=document.getElementById("victory");x(b,a)};a.show_elem=C});if(b4w.module_check("bonuses"))throw"Failed to register module: bonuses";
b4w.register("bonuses",function(a,b){function C(a){function b(a,g,e,l){if(1==e)switch(F.set_translation_v(l.empty,w.DEFAULT_POS),l.type){case w.BTYPE_HP:B.apply_hp_potion();t.play_def(D);break;case w.BTYPE_LAVA:c<=w.LAVA_FALL_LENGTH&&B.apply_lava_protect();c=w.BONUS_LAVA_PROT_TIME;t.play_def(p);break;case w.BTYPE_SHIELD:n<=w.SHIELD_FLASH_LENGTH&&B.apply_shield(),n=w.BONUS_SHIELD_TIME,t.play_def(y)}}function e(a,b,g,e){a=r.get_sensor_value(a,b,0);e.lifetime-=a;0<e.lifetime?(a=e.lifetime,4<a||(e=e.body,
a*=w.BONUS_FLASH_SPEED,.5<(1>a?a:a%Math.floor(a))?m.hide_object(e):m.show_object(e))):(F.set_translation_v(e.empty,w.DEFAULT_POS),e.is_spawned=!1)}for(var A=0;A<u.length;A++){var q=u[A],k=q.body,g=r.create_collision_sensor(k,"CHARACTER");r.create_sensor_manifold(k,"BONUS",r.CT_TRIGGER,[g],null,b,q);r.create_sensor_manifold(k,"BONUS_LIFETIME",r.CT_CONTINUOUS,[a],null,e,q)}}function x(a,b,e){for(var c=0;c<a.length;c++){var q;q=a[c];var k=b,g=e;q={empty:m.get_object_by_name(q),body:m.get_object_by_dupli_name(q,
g),lifetime:w.BONUS_LIFETIME,type:k,is_spawned:!1};u.push(q)}}var w=b("game_config"),F=b("transform"),r=b("controls"),m=b("scenes"),t=b("sfx"),B=b("character"),u=[],D=null,p=null,y=null,n=0,c=0;a.init=function(a,b){D=m.get_object_by_dupli_name(w.CHAR_EMPTY,w.CHAR_HEAL_SPEAKER);p=m.get_object_by_dupli_name(w.CHAR_EMPTY,w.CHAR_LAVA_SPEAKER);y=m.get_object_by_dupli_name(w.CHAR_EMPTY,w.CHAR_SHIELD_SPEAKER);u.length=0;x(w.HP_BONUSES_EMPTIES,w.BTYPE_HP,"potion_HP");x(w.LAVA_BONUSES_EMPTIES,w.BTYPE_LAVA,
"potion_LAVA");x(w.SHIELD_BONUSES_EMPTIES,w.BTYPE_SHIELD,"potion_SHIELD");C(a);r.create_sensor_manifold(null,"BONUS_TIMER",r.CT_CONTINUOUS,[a],null,function(a,b){var l=r.get_sensor_value(a,b,0);0<n&&(n-l<w.SHIELD_FLASH_LENGTH&&B.remove_shield(),n-=l);0<c&&(c-l<w.LAVA_FALL_LENGTH&&B.remove_lava_protect(),c-=l)})};a.spawn=function(a){for(var b=Math.floor(3*Math.random()),e=0;e<u.length;e++){var c=u[e];if(!c.is_spawned&&c.type==b)return a[2]+=.05,F.set_translation_v(c.empty,a),c.lifetime=w.BONUS_LIFETIME,
c.is_spawned=!0,m.show_object(c.body),!0}return!1};a.reset=function(){for(var a=0;a<u.length;a++)F.set_translation_v(u[a].empty,w.DEFAULT_POS)};a.set_shield_time=function(a){n=a};a.set_lava_protect_time=function(a){c=a};a.lava_protect_time_left=function(){return c};a.shield_time_left=function(){return n}});if(b4w.module_check("enemies"))throw"Failed to register module: enemies";
b4w.register("enemies",function(a,b){function C(a,b){var d=a.empty.name;a.walk_speaker=c.get_object_by_dupli_name(d,g.GOLEM_WALK_SPEAKER);a.attack_speaker=c.get_object_by_dupli_name(d,g.GOLEM_ATTACK_SPEAKER);a.hit_speaker=c.get_object_by_dupli_name(d,g.GOLEM_HIT_SPEAKER);a.getout_speaker=c.get_object_by_dupli_name(d,g.GOLEM_GETOUT_SPEAKER);switch(b){case "lava":a.type=g.EN_TYPE_GOLEM_LAVA;break;case "stone":a.type=g.EN_TYPE_GOLEM_STONE}a.death_anim="golem_death";a.walk_anim="golem_walk";a.atack_anim=
["golem_atack_01","golem_atack_02","golem_atack_03"];a.getout_anim="golem_"+b+"_getout";a.death_empty_name="golem_"+b+"_death";d=e.get_object_bounding_box(a.body);a.height=d.max_z-d.min_z}function x(a,b,k){if(0>=a.hp){b=a.empty;k=c.get_object_by_name(a.death_empty_name);var q=c.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_RIG),p=c.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_BLOW),f=Q,u=K;e.get_translation(b,f);e.get_rotation(b,u);e.set_translation_v(k,f);e.set_rotation_v(k,
u);l.apply(q,a.death_anim);l.set_behavior(q,l.AB_FINISH_STOP);l.play(q);l.play(p);h.stop(a.walk_speaker);e.set_translation_v(b,g.DEFAULT_POS);fa.spawn(f);"volcano"==d.LEVEL_NAME&&(b=a.island_id,a.island_id=-1,z.try_to_capture(b));a.hp=100;D(a,g.GS_NONE)}else if(G.get_wrapper().state!=g.CH_VICTORY)switch(k=n.get_sensor_value(a,b,1),a.dist_to_ground=10*k-a.height/2,a.state){case g.GS_ATTACKING:!a.attack_done&&l.get_frame(a.rig)>=g.GOLEM_ATTACK_ANIM_FRAME&&(a.last_target==g.GT_CHAR?v.check_attack(a.attack_point,
G.get_wrapper().phys_body,g.GOLEM_ATTACK_DIST)&&(b=g.GOLEM_ATTACK_STRENGTH,0<N.shield_time_left()&&(b*=g.BONUS_SHIELD_EFFECT),G.change_hp(-b),h.play_def(a.hit_speaker)):a.last_target==g.GT_OBELISK&&(b=a.island_id,z.num_gems(b)&&z.damage_obelisk(b),h.play_def(a.hit_speaker)),a.attack_done=!0);break;case g.GS_WALKING:b=n.get_sensor_value(a,b,0),k=G.get_wrapper(),"volcano"==d.LEVEL_NAME?(q=a.island_id,k.island==q&&0<k.hp?(r(a,k.phys_body,b),a.last_target=g.GT_CHAR):z.num_gems(q)?(k=c.get_object_by_dupli_name("obelisk_"+
q,"obelisk"),r(a,k,b),a.last_target=g.GT_OBELISK):m(a,b)):"dungeon"==d.LEVEL_NAME?0<k.hp&&v.check_visibility(a,k)&&a.can_see_char?(r(a,k.phys_body,b),a.last_target=g.GT_CHAR):m(a,b):m(a,b)}}function w(a){for(var b=[],k=[],l=[],q=[],f=0;f<d.LAVA_GOLEM_SPAWN_POINTS.length;f++){var h=c.get_object_by_name(d.LAVA_GOLEM_SPAWN_POINTS[f]),m=e.get_translation(h),h=e.get_rotation(h);b.push(m);l.push(h)}if(d.STONE_GOLEM_SPAWN_POINTS)for(f=0;f<d.STONE_GOLEM_SPAWN_POINTS.length;f++)h=c.get_object_by_name(d.STONE_GOLEM_SPAWN_POINTS[f]),
m=e.get_translation(h),h=e.get_rotation(h),k.push(m),q.push(h);n.create_sensor_manifold(null,"GOLEMS_SPAWN",n.CT_CONTINUOUS,[a],null,function(a,f){var e;a:{for(e=0;e<P.length;e++){var c=P[e];if(c.state==g.GS_NONE){e=c;break a}}e=null}if(e&&(c=n.get_sensor_value(a,f,0),H-=c,0>=H)){H=g.GOLEMS_SPAWN_INTERVAL;if("volcano"==d.LEVEL_NAME){if(c=p(),null==c)return}else c=0;e.type==g.EN_TYPE_GOLEM_LAVA?F(e,c,b,l):F(e,c,k,q)}})}function F(a,b,c,k){var l=a.empty,f="volcano"==d.LEVEL_NAME?c.length/d.NUM_OBELISKS:
c.length,m=Math.floor(Math.random()*f),f=f*b+m;c=c[f];k=k[f];e.set_translation_v(l,c);e.set_rotation_v(l,k);D(a,g.GS_GETTING_OUT);h.play_def(a.getout_speaker);"volcano"==d.LEVEL_NAME?(a.island_id=b,q.copy(c,a.dest_pos)):t(a,c)}function r(a,b,d){var c=Q,k=M;e.get_translation(a.empty,c);e.get_translation(b,k);k[2]=c[2];q.copy(k,a.dest_pos);b=q.distance(c,k);c=B(a,d);Math.abs(c)<Math.PI/6&&b>=g.GOLEM_ATTACK_DIST?u(a,d):Math.abs(c)<.05*Math.PI&&(d=a.empty,b=a.attack_point,c=Q,k=M,a.attack_done=!1,D(a,
g.GS_ATTACKING),e.get_translation(d,c),q.scaleAndAdd(c,k,g.GOLEM_ATTACK_DIST,b),b[2]+=a.height/2,h.is_play(a.walk_speaker)&&h.stop(a.walk_speaker),h.play_def(a.attack_speaker));a.type==g.EN_TYPE_GOLEM_STONE&&(l.set_speed(a.rig,g.STONE_GOLEMS_SP_MULT),a.speed=g.GOLEM_SPEED*g.STONE_GOLEMS_SP_MULT)}function m(a,b){l.set_speed(a.rig,1);a.speed=g.GOLEM_SPEED;var k=a.dest_pos,h=Q;e.get_translation(a.empty,h);var m=h[2];h[2]=k[2];k=q.distance(h,k);h[2]=m;if(!(.05<k&&a.last_target==g.GT_POINT)){if("volcano"==
d.LEVEL_NAME)b:{for(var m=a.dest_pos,k=a.dest_point,f=a.island_id,n=d.GOLEM_PATROL_POINTS,v=n.length/d.NUM_OBELISKS,p=Math.random(),r=Math.floor(v*p),G=0,p=0;p<v;p++)if(p!=k&&G++==r){f=c.get_object_by_name(n[v*f+p]);e.get_translation(f,m);m[2]=h[2];a.prev_dest=k;a.dest_point=p;break b}a.dest_point=-1}else a.last_target==g.GT_CHAR?t(a,h):(m=a.dest_pos,k=a.dest_point,f=d.GOLEM_PATROL_POINTS,n=d.GOLEM_PATROL_MAP[k],v=n.length-1,p=Math.random(),n=n[Math.floor(v*p)],f=c.get_object_by_name(f[n]),e.get_translation(f,
m),m[2]=h[2],a.prev_dest=k,a.dest_point=n);a.last_target=g.GT_POINT}h=B(a,b);Math.abs(h)<Math.PI/6&&u(a,b)}function t(a,b){for(var g=d.GOLEM_PATROL_POINTS,k=g.length,l=a.dest_pos,f=1E3,h=-1,m=0;m<k;m++){var n=c.get_object_by_name(g[m]);e.get_translation(n,M);n=q.distance(M,b);n<f&&(f=n,h=m,q.copy(M,l),l[2]=b[2])}a.dest_point=h}function B(a,b){var d=a.empty,c=a.dest_pos,l=Q,f=M,h=J,m=K,n=ca;e.get_translation(d,l);e.get_rotation(d,m);q.transformQuat(A.AXIS_MY,m,f);q.subtract(c,l,h);h[2]=0;q.normalize(h,
h);k.rotationTo(f,h,n);k.multiply(n,m,n);c=q.dot(f,h);c=Math.acos(1<c?1:-1>c?-1:c);l=Math.abs(c)/Math.PI;k.slerp(m,n,Math.min(b/l*g.GOLEM_ROT_SPEED,1),n);e.set_rotation_v(d,n);return c}function u(a,b){var d=Q,c=M,g=K,f=a.empty,k=a.walk_speaker;e.get_rotation(f,g);e.get_translation(f,d);q.transformQuat(A.AXIS_MY,g,c);q.scaleAndAdd(d,c,a.speed*b,d);c=b/3;d[2]-=a.dist_to_ground>c?c:a.dist_to_ground<-c?-c:c;e.set_translation_v(f,d);h.is_play(k)||(h.play_def(k),h.cyclic(k,!0))}function D(a,b){var d=a.rig;
switch(b){case g.GS_WALKING:l.apply(d,a.walk_anim);l.set_behavior(d,l.AB_CYCLIC);l.play(d);break;case g.GS_ATTACKING:var c=Math.floor(a.atack_anim.length*Math.random());l.apply(d,a.atack_anim[c]);l.play(d,function(){a.state!=g.GS_NONE&&D(a,g.GS_WALKING)});break;case g.GS_GETTING_OUT:l.apply(d,a.getout_anim),l.play(d,function(){a.state!=g.GS_NONE&&D(a,g.GS_WALKING)})}a.state=b}function p(){for(var a=d.NUM_OBELISKS,b=0;b<P.length;b++)y(b)||a--;if(0==a)return null;for(var a=Math.floor(Math.random()*
a),c=0,b=0;b<d.NUM_OBELISKS;b++)if(y(b)&&c++==a)return b;return null}function y(a){if(z.is_filled(a))return!1;for(var b=0;b<P.length;b++)if(P[b].island_id==a)return!1;return!0}var n=b("controls"),c=b("scenes"),l=b("animation"),h=b("sfx"),e=b("transform"),A=b("util"),q=b("vec3"),k=b("quat"),g=b("game_config"),G=b("character"),v=b("combat"),z=b("obelisks"),N=b("bonuses"),fa=b("gems"),E=b("physics"),d=null,P=[],Q=new Float32Array(3),M=new Float32Array(3),J=new Float32Array(3),K=new Float32Array(4),ca=
new Float32Array(4),H=0,O=new Float32Array(3);a.init=function(a,b){function k(a,b,d){b=n.get_sensor_value(a,"CHAR_RAY",0);d=n.get_sensor_payload(a,"CHAR_RAY",0);a.can_see_char=0==b?!0:!1;b=d.ray_test_id;d=G.get_wrapper();d=e.get_translation(d.phys_body,Q);a=e.get_translation(a.empty,M);E.change_ray_test_from_to(b,a,d)}d=b;H=g.GOLEMS_SPAWN_INTERVAL;for(var l=P.length=0;l<d.GOLEMS_EMPTIES.length;l++){var h=d.GOLEMS_EMPTIES[l],f=c.get_object_by_name(h),m=c.get_object_by_dupli_name(h,"golem_collider"),
h=c.get_object_by_dupli_name(h,"golem_armature");m&&h&&f&&(f={body:m,rig:h,empty:f,height:0,type:g.EN_TYPE_GOLEM_LAVA,view_distance:10,walk_speaker:null,attack_speaker:null,hit_speaker:null,getout_speaker:null,death_empty_name:null,hp:g.GOLEM_HP,speed:g.GOLEM_SPEED,island_id:-1,dest_point:-1,prev_dest:-1,dest_pos:new Float32Array(3),dist_to_ground:0,can_see_char:!1,last_target:g.GT_POINT,state:g.GS_NONE,attack_point:new Float32Array(3),attack_done:!1},h=-1!=m.name.indexOf("lava")?"lava":"stone",C(f,
h),m=n.create_ray_sensor(m,O,[0,0,-10],"GROUND",!1,!1,!0),h=n.create_ray_sensor(null,O,[0,0,-10],"COMMON",!0,!1,!0),n.create_sensor_manifold(f,"CHAR_RAY",n.CT_CONTINUOUS,[h],function(a){return!0},k),n.create_sensor_manifold(f,"GOLEM",n.CT_CONTINUOUS,[a,m],function(a){return!0},x),P.push(f),v.append_enemy(f))}w(a)};a.reset=function(){H=g.GOLEMS_SPAWN_INTERVAL;for(var a=0;a<P.length;a++){var b=P[a];b.island_id=-1;D(b,g.GS_NONE);e.set_translation_v(b.empty,g.DEFAULT_POS);h.stop(b.walk_speaker)}};a.island_has_enemies=
function(a){for(var b=0;b<P.length;b++)if(P[b].island_id==a)return!0;return!1}});if(b4w.module_check("combat"))throw"Failed to register module: combat";
b4w.register("combat",function(a,b){function C(a,b,m){var p=r;x.get_translation(b,p);return w.distance(p,a)<m?!0:!1}var x=b("transform"),w=b("vec3"),F=b("game_config"),r=new Float32Array(3),m=new Float32Array(3),t=[];a.append_enemy=function(a){t.push(a)};a.process_attack_on_enemies=function(a,b){for(var m=0;m<t.length;m++){var p=t[m];if(!(0>=p.hp||p.state==F.GS_NONE)&&C(a,p.empty,b))return p.hp-=F.CHAR_ATTACK_STR,!0}return!1};a.check_attack=C;a.check_visibility=function(a,b){var t=x.get_translation(a.body,
r),p=x.get_translation(b.body,m);return w.distance(t,p)>a.view_distance?!1:!0}});if(b4w.module_check("character"))throw"Failed to register module: character";
b4w.register("character",function(a,b){function C(a){function b(){0<f.hp&&f.state!=d.CH_VICTORY&&(Q.show_elem(c),Q.show_elem(e),n.pause())}var c=document.getElementById("game_menu"),e=document.getElementById("canvas_shadow");a=fa.get_canvas();0<f.hp&&!n.is_paused()&&f.state!=d.CH_VICTORY&&z.request_pointerlock(a,null,b,null,null,function(a,b){da(d.MOUSE_ROT_MULT*a,d.MOUSE_ROT_MULT*b)})}function x(){for(var a=function(a,b,d){f.island=1==d?parseInt(b[b.length-1]):-1},b=0;b<J.NUM_OBELISKS;b++){var d=
c.create_collision_sensor(f.picker,"ISLAND"+b);c.create_sensor_manifold(f.picker,"ISLE_COLL"+b,c.CT_TRIGGER,[d],null,a)}}function w(a){var b=c.create_ray_sensor(f.phys_body,[0,0,0],[0,0,-d.CHAR_RAY_LENGTH],"GROUND",!0),e=c.create_ray_sensor(f.phys_body,[0,0,0],[0,0,-d.CHAR_RAY_LENGTH],"LAVA",!0),g=c.create_ray_sensor(f.phys_body,[0,0,0],[0,0,-d.CHAR_RAY_LENGTH],"COMMON",!0);c.create_sensor_manifold(f.phys_body,"GROUND SENS",c.CT_TRIGGER,[b,e,g],function(a){return a[0]||a[1]||a[2]},function(b,d,f){c.set_custom_sensor(a,
1==f?1:0)})}function F(a,b,g,k,l){function m(a,b,e){if(f.state==d.CH_ATTACK)h.set_character_move_dir(a,0,0);else{var g=c.get_sensor_value(a,b,6);if(1==e){switch(b){case "FORWARD":r.forw_back=1;break;case "BACKWARD":r.forw_back=-1;break;case "LEFT":r.left_right=1;break;case "RIGHT":r.left_right=-1}f.state!=d.CH_JUMP&&(f.state=d.CH_RUN)}else{switch(b){case "FORWARD":case "BACKWARD":r.forw_back=0;break;case "LEFT":case "RIGHT":r.left_right=0}f.state!=d.CH_JUMP&&(f.state=d.CH_STILL)}(r.forw_back||r.left_right)&&
g?A.is_play(K)||A.play_def(K):A.is_play(K)&&A.stop(K);h.set_character_move_dir(a,r.forw_back,r.left_right)}}var n=c.create_keyboard_sensor(c.KEY_W),q=c.create_keyboard_sensor(c.KEY_S),p=c.create_keyboard_sensor(c.KEY_UP),v=c.create_keyboard_sensor(c.KEY_DOWN),ja=c.create_keyboard_sensor(c.KEY_A),na=c.create_keyboard_sensor(c.KEY_D);a=[n,p,a,q,v,b,l,ja,g,na,k];var r=f.move_state;c.create_sensor_manifold(f.phys_body,"FORWARD",c.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},m);c.create_sensor_manifold(f.phys_body,
"BACKWARD",c.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},m);c.create_sensor_manifold(f.phys_body,"LEFT",c.CT_CONTINUOUS,a,function(a){return a[7]||a[8]},m);c.create_sensor_manifold(f.phys_body,"RIGHT",c.CT_CONTINUOUS,a,function(a){return a[9]||a[10]},m);c.create_sensor_manifold(f.phys_body,"CHAR_ANIM",c.CT_CONTINUOUS,[l],function(a){return!0},function(a,b,g){f.state!=d.CH_ATTACK&&(c.get_sensor_value(a,b,0),a=e.get_current_anim_name(f.rig),b=d.CHAR_IDLE_ANIM,f.state==d.CH_JUMP?b=d.CHAR_JUMP_ANIM:
1==r.forw_back?b=d.CHAR_RUN_ANIM:-1==r.forw_back?(b=d.CHAR_RUN_ANIM,e.set_speed(f.rig,-1)):1==r.left_right?(b=d.CHAR_STRAFE,e.set_speed(f.rig,-1)):-1==r.left_right&&(b=d.CHAR_STRAFE),a!=b&&(e.apply(f.rig,b),e.play(f.rig),e.set_behavior(f.rig,e.AB_CYCLIC)))});f.body&&(e.apply(f.body,d.CHAR_HEAL_PICK_ANIM),e.apply(f.body,d.CHAR_LAVA_PROT_ANIM,e.SLOT_1),e.apply(f.body,d.CHAR_SHIELD_PICK_ANIM,e.SLOT_2));A.stop(K)}function r(a,b){var g=c.create_keyboard_sensor(c.KEY_SPACE);c.create_sensor_manifold(f.phys_body,
"JUMP",c.CT_TRIGGER,[g,a,b],function(a){return(a[0]||a[1])&&a[2]},function(a,b,c){1==c&&f.state!=d.CH_ATTACK&&(f.state=d.CH_JUMP,h.character_jump(a),b=Math.floor(L.length*Math.random()),A.play_def(L[b]),e.apply(f.rig,d.CHAR_JUMP_ANIM),e.set_behavior(f.rig,e.AB_FINISH_STOP),e.play(f.rig),f.move_state.forw_back=0,f.move_state.left_right=0)});c.create_sensor_manifold(f.phys_body,"LANDING",c.CT_TRIGGER,[b],null,function(a,b,c){1==c&&(A.play_def(O),f.state!=d.CH_ATTACK&&(f.state=d.CH_STILL))})}function m(a,
b){function l(a){e.apply(f.rig,d.CHAR_IDLE_ANIM);e.set_behavior(f.rig,e.AB_CYCLIC);e.play(f.rig);f.state=d.CH_STILL}var m=c.create_mouse_click_sensor(),n=!1;c.create_sensor_manifold(f.phys_body,"ATTACK",c.CT_TRIGGER,[m,a],function(a){return a[0]||a[1]},function(a,b,c){1==c&&f.state!=d.CH_ATTACK&&(f.state=d.CH_ATTACK,f.move_state.forw_back=0,f.move_state.left_right=0,a=Math.floor(T.length*Math.random()),e.apply(f.rig,T[a]),e.set_behavior(f.rig,e.AB_FINISH_STOP),e.play(f.rig,l),h.set_character_move_dir(f.phys_body,
0,0),n=!1,A.is_play(K)&&A.stop(K),A.play_def(ca),a=Math.floor(ba.length*Math.random()),A.play_def(ba[a]))});c.create_sensor_manifold(f.phys_body,"DAMAGE_GOLEMS",c.CT_CONTINUOUS,[b],null,function(a,b,c){if(f.state==d.CH_ATTACK&&!n&&e.get_frame(f.rig)>=d.CHAR_ATTACK_ANIM_FRAME){a=X;b=aa;c=S;var h=Y,l=d.CHAR_ATTACK_DIST;k.get_translation(f.phys_body,a);k.get_rotation(f.phys_body,h);G.transformQuat(g.AXIS_MY,h,b);G.scaleAndAdd(a,b,l,c);P.process_attack_on_enemies(c,l)&&(A.play_def(H),e.play(f.hitsparks));
n=!0}})}function t(){c.check_sensor_manifolds(f.phys_body)&&c.remove_sensor_manifold(f.phys_body);h.set_character_move_dir(f.phys_body,0,0);A.stop(K);fa.get_canvas();n.detect_mobile()||z.exit_pointerlock()}function B(){var a=0;c.create_sensor_manifold(f.phys_body,"CHAR_HURT",c.CT_CONTINUOUS,[c.create_elapsed_sensor()],null,function(){var b=Math.max(V-q.get_timeline()+1,0);b==a&&0==a?a=b:(a=b,E.set_nodemat_value(Z,["camera_indicator",d.CAM_INDICATOR_VAL],b))})}function u(){M.set_lava_protect_time(0);
E.set_nodemat_value(f.lava_shield_prot,["lava_shield_prot","lava_prot_switcher"],0)}function D(){M.set_shield_time(0);E.set_nodemat_value(f.lava_shield_prot,["lava_shield_prot","shield_switcher"],0)}function p(a){if(!(0>=f.hp)){var b=q.get_timeline();if(0>a&&V<b-.5){var c=Math.floor(R.length*Math.random());A.play_def(R[c]);V=b}f.hp+=a;f.hp=Math.min(f.hp,d.MAX_CHAR_HP);0>=f.hp&&(t(),J.MUSIC_SPEAKERS&&(A.clear_playlist(),a=l.get_object_by_dupli_name_list(J.MUSIC_INTRO_SPEAKER),b=l.get_object_by_dupli_name_list(J.MUSIC_END_SPEAKER),
A.stop(a),A.play_def(b)),a=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_DEATH_SPEAKER),A.play_def(a),a=Math.floor(W.length*Math.random()),e.apply(f.rig,W[a]),e.set_behavior(f.rig,e.AB_FINISH_STOP),e.play(f.rig),Q.show_replay_button(1),f.gem_slot&&y(),0<M.shield_time_left()&&D(),0<M.lava_protect_time_left()&&u(),E.set_nodemat_value(Z,["camera_indicator",d.CAM_INDICATOR_VAL],1));Q.update_hp_bar()}}function y(){var a=f.gem_slot.empty;v.remove(a);k.set_translation_v(a,d.DEFAULT_POS);k.set_scale(a,1);
f.gem_slot.state=d.GM_SPARE;f.gem_slot=null}var n=b("main"),c=b("controls"),l=b("scenes"),h=b("physics"),e=b("animation"),A=b("sfx"),q=b("time"),k=b("transform"),g=b("util"),G=b("vec3"),v=b("constraints"),z=b("mouse"),N=b("camera"),fa=b("container"),E=b("material");b("quat");var d=b("game_config"),P=b("combat"),Q=b("interface"),M=b("bonuses");b("environment");var J=null,K=null,ca=null,H=null,O=null,I=null,U=null,L=[],ba=[],R=[],f=null,da=null,T=[],W=[],V=-100,Z=null,ia=new Float32Array(2),X=new Float32Array(3),
aa=new Float32Array(3),S=new Float32Array(3),Y=new Float32Array(4);a.init_wrapper=function(a,b){J=a;f={phys_body:l.get_first_character(),rig:l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_ARMAT),body:l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_MODEL),picker:l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_PICKER),target:l.get_object_by_dupli_name(d.CHAR_EMPTY,"camera_target"),lava_shield_prot:l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_SPHERE),hitsparks:l.get_object_by_dupli_name(d.CHAR_EMPTY,
"sword_hitsparks_emitter"),foot_smoke:l.get_object_by_dupli_name(d.CHAR_EMPTY,"foots_smoke_emitter"),hp:d.MAX_CHAR_HP,state:d.CH_STILL,move_state:{forw_back:0,left_right:0},gem_slot:null,island:-1};e.apply_def(f.hitsparks);e.set_behavior(f.hitsparks,e.AB_FINISH_RESET);E.set_nodemat_value(f.lava_shield_prot,["lava_shield_prot","lava_prot_switcher"],0);E.set_nodemat_value(f.lava_shield_prot,["lava_shield_prot","shield_switcher"],0);l.hide_object(f.foot_smoke);a&&"dungeon"==a.LEVEL_NAME?E.set_nodemat_value(f.body,
["petigor",d.CHAR_SWORD_SWITCHER],1):E.set_nodemat_value(f.body,["petigor",d.CHAR_SWORD_SWITCHER],0);L.length=0;ba.length=0;R.length=0;T.length=0;W.length=0;K=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_RUN_SPEAKER);ca=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_ATTACK_SPEAKER);H=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_SWORD_SPEAKER);O=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_LANDING_SPEAKER);U=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_WIN_SPEAKER);I=l.get_object_by_dupli_name(d.CHAR_EMPTY,
d.GEM_PICKUP_SPEAKER);A.cyclic(U,!0);for(var c=0;c<d.CHAR_JUMP_SPKS.length;c++){var g=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_JUMP_SPKS[c]);L.push(g)}for(c=0;c<d.CHAR_ATTACK_VOICE_SPKS.length;c++)g=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_ATTACK_VOICE_SPKS[c]),ba.push(g);for(c=0;c<d.CHAR_HURT_SPKS.length;c++)g=l.get_object_by_dupli_name(d.CHAR_EMPTY,d.CHAR_HURT_SPKS[c]),R.push(g);for(c=0;c<d.CHAR_ATTACK_ANIMS.length;c++)T.push(d.CHAR_ATTACK_ANIMS[c]);for(c=0;c<d.CHAR_DEATH_ANIMS.length;c++)W.push(d.CHAR_DEATH_ANIMS[c]);
B()};a.setup_controls=function(a){function b(a,c){h.character_rotation_inc(f.phys_body,a,0);c&&(N.eye_rotate(y,0,c),N.get_camera_angles(y,X),ja[1]=na*Math.cos(X[1]),ja[2]=-na*Math.sin(X[1]),v.append_semi_stiff_cam(y,f.target,ja,null,0,0,qa,.01))}J&&"volcano"==J.LEVEL_NAME&&x();var g=c.create_custom_sensor(0),e=c.create_custom_sensor(0),q=c.create_custom_sensor(0),p=c.create_custom_sensor(0),t=c.create_custom_sensor(0),u=c.create_custom_sensor(0),z=c.create_custom_sensor(0);w(z);var y=l.get_active_camera(),
ja=new Float32Array(d.CAM_OFFSET),na=G.length(ja),qa=Math.PI/3;da=b;n.detect_mobile()?Q.setup_touch_controls(g,q,e,p,t,u,b):fa.get_canvas().addEventListener("mouseup",C,!1);F(q,p,e,g,z);r(t,z);m(u,a);a=k.get_translation(f.target,X);v.append_semi_stiff_cam(y,f.target,ja,null,0,0,qa,.01);N.eye_set_look_at(y,null,a);J&&(Z=l.get_object_by_dupli_name_list(d.CAMERA_INDICTAOR),E.set_nodemat_value(Z,["camera_indicator",d.CAM_INDICATOR_VAL],0))};a.pointerlock_cb=C;a.run_victory=function(){f.state=d.CH_VICTORY;
t();e.apply(f.rig,d.CHAR_VICTORY_ANIM);e.set_behavior(f.rig,e.AB_CYCLIC);e.play(f.rig);A.play_def(U);var a=l.get_active_camera();v.remove(a);var b={pivot:k.get_translation(f.target)};N.target_setup(a,b);c.create_elapsed_sensor();c.create_sensor_manifold(a,"CAMERA_ROTATION",c.CT_CONTINUOUS,[c.create_elapsed_sensor()],null,function(a,b,d){d=N.get_camera_angles(a,ia);var f=N.target_get_distance(a);b=c.get_sensor_value(a,b,0);N.target_rotate(a,.1*b,d[1]<J.VICT_CAM_VERT_ANGLE?.05*b:0);f>J.VICT_CAM_DIST&&
N.target_set_distance(a,f-b)})};a.reset=function(){f.state=d.CH_STILL;f.hp=d.MAX_CHAR_HP;f.island=-1;f.move_state.forw_back=0;f.move_state.left_right=0;J&&(k.get_rotation(f.phys_body,Y),h.set_transform(f.phys_body,J.CHAR_DEF_POS,Y),h.set_character_move_dir(f.phys_body,0,0),l.hide_object(f.foot_smoke));A.stop(U);var a=l.get_active_camera();c.check_sensor_manifold(a,"CAMERA_ROTATION")&&c.remove_sensor_manifold(a,"CAMERA_ROTATION");N.eye_setup(a);B()};a.apply_hp_potion=function(){p(d.BONUS_HP_INCR);
e.play(f.body)};a.apply_lava_protect=function(){e.set_behavior(f.body,e.AB_FINISH_STOP,e.SLOT_1);e.play(f.body,null,e.SLOT_1);E.set_nodemat_value(f.lava_shield_prot,["lava_shield_prot","lava_prot_switcher"],1)};a.remove_lava_protect=u;a.apply_shield=function(){e.set_behavior(f.body,e.AB_FINISH_STOP,e.SLOT_2);e.play(f.body,null,e.SLOT_2);E.set_nodemat_value(f.lava_shield_prot,["lava_shield_prot","shield_switcher"],1)};a.remove_shield=D;a.change_hp=p;a.add_gem=function(a){var b=a.empty;if(f.gem_slot){if(f.gem_slot==
a)return;y()}b=a.empty;v.append_stiff(b,f.phys_body,d.GEM_OFFSET,d.GEM_ROT_OFFSET,d.GEM_SCALE_OFFSET);a.state=d.GM_CARRIED;f.gem_slot=a;A.play_def(I)};a.remove_gem=y;a.get_wrapper=function(){return f}});if(b4w.module_check("environment"))throw"Failed to register module: environment";
b4w.register("environment",function(a,b){function C(a){function b(a,c,d,g,k,n){l.spawn(k)&&(u.set_translation_v(e,k),m.play(h))}var c=t.create_timer_sensor(a.BONUS_SPAWN_PERIOD,!0),e=B.get_object_by_name(a.BONUS_SPAWN_SPHERE),h=B.get_object_by_dupli_name(a.BONUS_SPAWN_SPHERE,a.BONUS_SPAWN_SPHERE);m.set_behavior(h,m.AB_FINISH_RESET);m.set_frame(h,0);t.create_sensor_manifold(null,"BONUS_SPAWN",t.CT_SHOT,[c],null,function(a,c,d){a=q;a[0]=40*Math.random()-20;a[1]=40*Math.random()-20;a[2]=20;c=k;k[0]=
a[0];k[1]=a[1];k[2]=-10;y.append_ray_test_ext(null,a,c,"GROUND",b,!0,!1,!0,!1)})}function x(a,b){function r(a,b,d,e){var g=t.get_sensor_value(a,b,0);b=e.mark;u.set_scale(b,0);e.falling_time+=g;if(e.falling_time<=h.ROCK_FALL_DELAY)e.terrain_type=-1;else{d=q;var v=k;u.get_translation(a,d);u.get_translation(b,v);d[2]-=h.ROCK_SPEED*g;u.set_translation_v(a,d);a=1-Math.abs(d[2]-v[2])/h.ROCK_RAY_LENGTH;u.set_scale(b,a);if(d[2]<=v[2]){g=q;d=e.burst;a=e.speaker;var G=e.mark,v=n.get_wrapper();u.get_translation(v.phys_body,
g);b=k;u.get_translation(G,b);g=D.distance(g,b);u.set_translation_v(d,b);m.set_frame(d,0,m.SLOT_ALL);m.play(d,null,m.SLOT_ALL);g<h.ROCK_DAMAGE_RADIUS&&v.state!=c.CH_VICTORY&&(d=-h.ROCK_DAMAGE,0<l.shield_time_left()&&(d*=c.BONUS_SHIELD_EFFECT),n.change_hp(d));d=Math.random()<c.BONUS_SPAWN_CHANCE;1==e.terrain_type&&d&&l.spawn(b);p.play_def(a);F(e)}}}for(var z=0;z<h.ROCK_EMPTIES.length;z++)for(var x=h.ROCK_EMPTIES[z],y=0;y<h.ROCK_NAMES.length;y++){var A=h.BURST_EMITTER_NAMES[y],d=h.MARK_NAMES[y],C=B.get_object_by_dupli_name(x,
h.ROCK_NAMES[y]),d=B.get_object_by_dupli_name(x,d),A=B.get_object_by_dupli_name(x,A),Q=B.get_object_by_dupli_name(x,h.ROCK_HIT_SPEAKERS[y]),d={rock:C,mark:d,burst:A,speaker:Q,lava_height:h.ROCK_RAY_LENGTH,ground_height:h.ROCK_RAY_LENGTH,terrain_type:-1,falling_time:0};t.create_sensor_manifold(C,"ROCK_FALL",t.CT_CONTINUOUS,[a],null,r,d);F(d);w(d);e.push(d)}}function w(a){var b=a.rock,c=a.mark,e=[0,0,-h.ROCK_RAY_LENGTH];y.append_ray_test_ext(b,A,e,"LAVA",function(b,e,k,d,h,l){a.lava_height=h[2];-1==
a.terrain_type&&(a.terrain_type=0,h[2]+=.1,u.set_translation_v(c,h),u.set_scale(c,1-e))},!1,!1,!0,!0);y.append_ray_test_ext(b,A,e,"GROUND",function(b,e,k,d,h,l){a.ground_height=h[2];1!=a.terrain_type&&(a.terrain_type=1,h[2]+=.1,u.set_translation_v(c,h),u.set_scale(c,1-e))},!1,!1,!0,!0)}function F(a){var b=q,c=a.rock;b[0]=32*Math.random()-16;b[1]=32*Math.random()-16;b[2]=16*Math.random()+8;u.set_translation_v(c,b);a.falling_time=0;a.terrain_type=-1}function r(a){var b=0,e=n.get_wrapper(),k=t.create_ray_sensor(e.phys_body,
[0,0,0],[0,0,-c.CHAR_RAY_LENGTH],"LAVA",!0);t.remove_sensor_manifold(e.phys_body,"LAVA_COLLISION");t.create_sensor_manifold(e.phys_body,"LAVA_COLLISION",t.CT_CONTINUOUS,[k,a],function(a){return a[0]},function(a,g,k){1==k?(B.show_object(e.foot_smoke),a=t.get_sensor_value(a,g,1),b+=a,b>=c.LAVA_DAMAGE_INTERVAL&&(a=a<c.LAVA_DAMAGE_INTERVAL?1:Math.floor(a/c.LAVA_DAMAGE_INTERVAL),0>=l.lava_protect_time_left()&&n.change_hp(-a),b=0)):(B.hide_object(e.foot_smoke),b=0)});"dungeon"==h.LEVEL_NAME&&(a=B.get_object_by_dupli_name("level_02_enviroment",
"lava"),m.apply_def(a),m.set_behavior(a,m.AB_FINISH_STOP),m.stop(a),m.set_frame(a,0),a=B.get_object_by_dupli_name("lava_death_controller","lava_death_controller"),m.apply_def(a))}var m=b("animation"),t=b("controls"),B=b("scenes"),u=b("transform"),D=b("vec3"),p=b("sfx"),y=b("physics"),n=b("character"),c=b("game_config"),l=b("bonuses"),h=null,e=[],A=[0,0,0],q=new Float32Array(3),k=new Float32Array(3);a.init=function(a,b){h=b;r(a);h.ROCK_EMPTIES&&x(a,h);"dungeon"==h.LEVEL_NAME&&C(b)};a.reset=function(a){if(h.ROCK_EMPTIES)for(var b=
0;b<e.length;b++)F(e[b]);r(a)};a.disable_environment=function(){for(var a=0;a<e.length;a++){var b=e[a],k=b.mark;t.remove_sensor_manifold(b.rock);F(b);u.set_translation_v(k,c.DEFAULT_POS)}e.length=0}});if(b4w.module_check("game_main"))throw"Failed to register module: game_main";
b4w.register("game_main",function(a,b){function C(){var a=m.get_object_by_dupli_name_list(["training_scene","training_dummy","training_dummy"]),b=m.get_object_by_dupli_name_list(["training_scene","Circle"]),c=u.create(),e=u.create();D.apply_constraint("GENERIC_6_DOF_SPRING",a,[0,-1.05,0],c,b,[-3.5,.1,-1.6],e,{use_limit_x:!0,use_limit_y:!0,use_limit_z:!0,use_angular_limit_x:!0,use_angular_limit_y:!0,use_angular_limit_z:!1,limit_max_x:0,limit_min_x:0,limit_max_y:0,limit_min_y:0,limit_max_z:0,limit_min_z:0,
limit_angle_max_x:.5,limit_angle_min_x:-.5,limit_angle_max_y:.5,limit_angle_min_y:-.5,limit_angle_max_z:.5,limit_angle_min_z:-.5},[0,0,0,200,200,200],[2,2,2,.01,.01,.01])}function x(a){r.remove_sensor_manifold(null,"PLAYLIST");y.reset();q&&(e.reset(),n.reset(),l.reset(),h.reset(),A.reset(a));y.setup_controls(a);c.update_hp_bar();w()}function w(){if(q&&q.MUSIC_SPEAKERS){var a=m.get_object_by_dupli_name_list(q.MUSIC_INTRO_SPEAKER),b=m.get_object_by_dupli_name_list(q.MUSIC_END_SPEAKER);a&&b&&(t.play_def(a),
t.stop(b),a=t.get_duration(a)*t.get_playrate(a),r.create_sensor_manifold(null,"PLAYLIST",r.CT_SHOT,[r.create_timer_sensor(a)],null,function(a,b,c){r.remove_sensor_manifold(null,"PLAYLIST");if(!(0>=y.get_wrapper().hp)){a=[];b=q.MUSIC_SPEAKERS;for(c=0;c<b.length;c++){var e=m.get_object_by_dupli_name_list(b[c]);a.push(e)}t.apply_playlist(a,0,!0)}}))}}var F=b("app"),r=b("controls"),m=b("scenes");b("print");var t=b("sfx"),B=b("container"),u=b("quat"),D=b("physics");b("transform");var p=b("game_config"),
y=b("character");b("combat");var n=b("bonuses"),c=b("interface"),l=b("enemies"),h=b("obelisks"),e=b("gems"),A=b("environment"),q=null;new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(4);new Float32Array(4);a.level_load_cb=function(a,g,t,u,z){a=r.create_elapsed_sensor();q=null;if("under_construction"!=g){if("level_01"==g||"level_02"==g)q=b(g+"_config");if("level_02"!=g){var D=m.get_object_by_dupli_name(p.CHAR_EMPTY,p.CHAR_LIGHT);m.hide_object(D)}"training"==
g&&C();y.init_wrapper(q,g);y.setup_controls(a);q&&(n.init(a,q),l.init(a,q),e.init(q),A.init(a,q),h.init(a,q),w())}else F.enable_camera_controls();setTimeout(function(){B.get_container().style.opacity=1},1E3);c.init(x,a,u,t,y.pointerlock_cb,g,z)}});if(b4w.module_check("start_menu"))throw"Failed to register module: intro_main";
b4w.register("start_menu",function(a,b){function C(a,b){b?(S=a,document.getElementById("preloader_cont").style.visibility="visible",q.detect_mobile()?G.load(ma+"intro_LQ.json",x,h,!0):G.load(ma+"intro_HQ.json",x,h,!0)):fa.log("b4w init failure")}function x(a){ba=L=!1;R=null;Y=S.width/2;ga=S.height/2;d.enqueue([["config",d.AT_JSON,"js/intro_config.json"]],w,null);a=z.get_active_camera();g.get_camera_angles(a,ea);setTimeout(function(){Q.get_container().style.opacity=1},1E3);q.detect_mobile()?S.addEventListener("touchstart",
B,!1):(a=v.create_ray_sensor(a,ia,X,"BUTTON",!0,!1,!0),v.create_sensor_manifold(null,"BUTTON_HOVER",v.CT_CONTINUOUS,[a],function(a){return!0},function(a,b,c){c=v.get_sensor_value(a,b,0);a=v.get_sensor_payload(a,b,0);b=a.obj_hit;Z=a.ray_test_id;c?b!=R&&(R=b,(c=f[b.name])&&c.speaker&&E.play_def(c.speaker)):R=null}),S.addEventListener("mousedown",u,!1),S.addEventListener("mousemove",t,!1),setTimeout(function(){L||ba||n()},1E4))}function w(a,b,c,d){b=a.buttons_info;c=v.create_elapsed_sensor();for(d=0;d<
b.length;d++){var e=b[d],g=z.get_object_by_dupli_name_list(e.button_name.split("*"));if(g){var g=g.name,k=z.get_object_by_dupli_name_list(e.mouse_over_speaker.split("*"));E.stop(k);var h=[],l=e.glow_obj_names;if("object"==typeof l)for(var n=0;n<l.length;n++){var p=z.get_object_by_dupli_name_list(l[n].split("*"));p&&h.push(p)}else h.push(z.get_object_by_dupli_name_list(l.split("*")));f[g]={glow_objs:h,speaker:k,level_name:e.level_name,material:e.material,value_node_name:e.value_node_name,glow_grow_time:e.glow_grow_time,
min_glow_value:e.min_glow_value,max_glow_value:e.max_glow_value,glow_curr_value:e.min_glow_value,outline_grow_time:e.outline_grow_time,min_outline_value:e.min_outline_value,max_outline_value:e.max_outline_value,outline_curr_value:e.min_outline_value}}}v.create_sensor_manifold(null,"GLOW",v.CT_CONTINUOUS,[c],null,r);v.create_sensor_manifold(null,"ROT_CAMERA",v.CT_CONTINUOUS,[c],null,m);F(a);b=1;"ru"==pa&&(b=0);c=z.get_object_by_dupli_name_list(a.language_obj.split("*"));P.set_nodemat_value(c,["main_menu_stone",
"language_switcher"],b);q.detect_mobile()||(ra=z.get_object_by_name(a.back_to_menu_obj_name),P.set_nodemat_value(ra,["back_to_main_menu","back_button_language"],b));b=z.get_active_camera();oa=a.camera_rotation_fac;O.copy(a.camera_pivot,ka);J.get_translation(b,la);ha=O.distance(ka,la)}function F(a){T=z.get_object_by_dupli_name_list(a.intro_speaker.split("*"));V=z.get_object_by_dupli_name_list(a.end_speaker.split("*"));a=a.playlist_speakers;for(var b=0;b<a.length;b++){var c=z.get_object_by_dupli_name_list(a[b].split("*"));
E.stop(c);W.push(c);E.mute(c,!1)}a=E.get_duration(T)*E.get_playrate(T);E.mute(T,!1);E.mute(V,!1);E.stop(V);E.play_def(T);v.create_sensor_manifold(null,"PLAYLIST",v.CT_SHOT,[v.create_timer_sensor(a)],null,function(a,b,c){da||(E.stop(T),E.apply_playlist(W,0,!0))})}function r(a,b,c){a=v.get_sensor_value(a,b,0);for(var d in f){b=f[d];var e=b.glow_curr_value,g=b.min_glow_value,k=b.max_glow_value,h=a/b.glow_grow_time;c=b.outline_curr_value;var l=b.min_outline_value,m=b.max_outline_value,n=a/b.outline_grow_time;
R&&d==R.name&&(e<k&&(b.glow_curr_value+=h),void 0!==c&&c<m&&(b.outline_curr_value+=n));R&&d==R.name||(e>g&&(b.glow_curr_value-=h),void 0!==c&&c>l&&(b.outline_curr_value-=n));if(void 0!==e&&b.glow_curr_value!=e)for(e=0;e<b.glow_objs.length;e++)P.set_nodemat_value(b.glow_objs[e],[b.material,b.value_node_name],b.glow_curr_value);if(void 0!==c&&b.outline_curr_value!=c)for(e=0;e<b.glow_objs.length;e++)z.set_outline_intensity(b.glow_objs[e],b.outline_curr_value)}}function m(a,b,c){M.is_play()||null===ha||
(a=z.get_active_camera(),c=S.width/2,b=S.height/2,g.get_camera_angles(a,sa),c=ea[0]-(c-Y)/S.width*oa,b=-ea[1]-(b-ga)/S.height*oa,la[0]=ka[0]+ha*Math.sin(c),la[1]=ka[1]-ha*Math.cos(c),la[2]=ka[2]+ha*Math.sin(b),g.static_set_look_at(a,la,ka),g.correct_up(a))}function t(a){a.preventDefault&&a.preventDefault();var b=a.clientX;a=a.clientY;Y=b;ga=a;if(null!==Z){var c=z.get_active_camera();g.calc_ray(c,b,a,aa);H.get_pline_directional_vec(aa,X);O.scale(X,100,X);ca.change_ray_test_from_to(Z,ia,X)}}function B(a){a.preventDefault&&
a.preventDefault();a=a.changedTouches[0];D(a.clientX,a.clientY)}function u(a){a.preventDefault&&a.preventDefault();D(a.clientX,a.clientY)}function D(a,b){var d=z.pick_object(a,b);if(d&&(R=d,f[d.name])){var e=f[d.name];e.level_name?(p(),setTimeout(function(){l(e.level_name)},1E3*I.LEVEL_LOAD_DELAY)):q.detect_mobile()||(c(),p(),y())}}function p(){ba=!0;q.detect_mobile()?S.removeEventListener("touchstart",B,!1):(S.removeEventListener("mousedown",u),S.removeEventListener("mousemove",t))}function y(){L||
n();v.remove_sensor_manifold(null,"ROT_CAMERA");v.remove_sensor_manifold(null,"BUTTON_HOVER");v.create_sensor_manifold(null,"TIMELINE_CHECK",v.CT_SHOT,[v.create_elapsed_sensor()],function(a){return M.get_frame()>=M.get_frame_end()},function(){l("level_01")})}function n(){E.duck(null,0,1);var a=z.get_object_by_name("environment_LQ");document.getElementById("preloader_cont").style.visibility="visible";G.load(ma+"intro_HQ_environment.json",function(){z.hide_object(a);E.duck(null,1,1);L=!0},h,!0,!1)}
function c(a){for(a=0;a<W.length;a++){var b=W[a];E.is_play(b)&&E.duck(b,0,1)}E.duck(T,0,1);setTimeout(function(){E.clear_playlist();da=!0;E.play_def(V)},1E3)}function l(a){var b=ma+a+".json";G.unload(G.DATA_ID_ALL);document.getElementById("preloader_cont").style.visibility="visible";G.load(b,function(b){U.level_load_cb(b,a,h,x,l)},h,!0)}function h(a){var b=document.getElementById("prelod_dynamic_path"),c=b.nextElementSibling;b.style.width=a+"%";c.innerHTML=a+"%";100==a&&e()}function e(){var a=document.getElementById("preloader_cont");
setTimeout(function(){a.style.visibility="hidden"},1E3)}function A(){function a(b){y.setAttribute("lang",b);l.setAttribute("src","interface/start_game_"+b+".png");pa=b}function b(a){n.setAttribute("quality",a);document.location.hash="quality="+a}function c(){m.style.display="inline-block"}function d(){v.className="brand hover"}function e(){w.className="soc hover"}function f(){m.style.display=""}function g(){v.className="brand"}function h(){w.className="soc"}var l=document.getElementById("start_game"),
m=document.getElementById("start_game_hover"),n=document.getElementById("quality"),p=document.getElementById("start_cont"),r=document.getElementById("lang_ru"),t=document.getElementById("lang_en"),u=document.getElementById("low_qual"),x=document.getElementById("high_qual"),y=document.body,v=document.getElementsByClassName("brand")[0],w=document.getElementsByClassName("soc")[0];p.style.display="block";p.style.opacity=1;document.location.hash="quality=high";r.addEventListener("click",function(){a("ru")},
!1);t.addEventListener("click",function(){a("en")},!1);u.addEventListener("click",function(){b("low")},!1);x.addEventListener("click",function(){b("high")},!1);q.detect_mobile()?(l.addEventListener("touchstart",c),l.addEventListener("touchend",f),v.addEventListener("touchstart",d),v.addEventListener("touchend",g),w.addEventListener("touchstart",e),w.addEventListener("touchend",h),b("low")):(l.addEventListener("mousedown",c),l.addEventListener("mouseup",f),l.addEventListener("mouseleave",f),v.addEventListener("mousedown",
d),v.addEventListener("mouseup",g),v.addEventListener("mouseleave",g),w.addEventListener("mousedown",e),w.addEventListener("mouseup",h),w.addEventListener("mouseleave",h));l.addEventListener("click",function(){p.style.visibility="hidden";var a=q.detect_mobile(),b="DEBUG"==K.type(),c="high"!=document.getElementById("quality").getAttribute("quality")||a?N.P_LOW:N.P_HIGH;k.init({canvas_container_id:"canvas3d",callback:C,quality:c,physics_enabled:!0,console_verbose:!0,alpha:!1,physics_use_workers:!a,
assets_dds_available:!b,assets_pvr_available:!b,assets_min50_available:!b,show_fps:b,autoresize:!0})},!1)}var q=b("main"),k=b("app"),g=b("camera"),G=b("data"),v=b("controls"),z=b("scenes"),N=b("config"),fa=b("print"),E=b("sfx");b("time");var d=b("assets"),P=b("material"),Q=b("container");b("util");var M=b("nla"),J=b("transform"),K=b("version"),ca=b("physics"),H=b("math"),O=b("vec3");b("quat");var I=b("game_config"),U=b("game_main"),L=!1,ba=!1,R=null,f={},da=!1,T=null,W=[],V=null,Z=null,ia=new Float32Array(3),
X=new Float32Array(3),aa=H.create_pline(),S=null,Y=0,ga=0,ea=new Float32Array(2),ha=null,ka=new Float32Array(3),oa=0,la=new Float32Array(3),pa="en",ra=null,sa=new Float32Array(2),ma=N.get_std_assets_path()+"petigors_tale/";a.init=function(){window.addEventListener("load",A)}});b4w.require("start_menu").init("en");
