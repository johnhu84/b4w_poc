b4w.register("state_machine",function(b,a){function E(g,a,c){for(var f=null,p=0;p<g.nodes.length;p++)if(g.nodes[p].id==a){f=g.nodes[p];break}return g.instances[c].current_node=f}function x(g,a){return g.instances[a].current_node}var v="DEBUG"===a("version").type();b.state_machine_create=function(){return{nodes:[],instances:[],lock:!1}};b.state_machine_add_state=function(g,a,c,f,p,b,v,x,B){g.nodes.push({id:a,allowed_ids:c,call_before_switch:f,call_after_switch:p,call_switch_from:b,call_switch_to:v,
init_state:x,payload:B,instances:[]})};b.state_machine_validate=function(g){for(var a=[],c=0;c<g.nodes;c++){var f=g.nodes[c].id;if(0<=a.indexOf(f))return v&&console.log("Found states with the same id "+f),!1;a.push(f)}for(c=0;c<g.nodes;c++)for(var f=g.nodes[c],b=0;b<f.allowed_ids.length;b++)if(0>a.indexOf(f.allowed_ids[b]))return v&&console.log("Found bad id"+f.allowed_ids[b]),!1;return!0};b.state_machine_create_instance=function(g){g.instances.push({current_node:null});for(var a=g.instances.length-
1,c=0;c<g.nodes.length;c++)g.nodes[c].instances.push({}),g.nodes[c].init_state&&g.nodes[c].init_state(g.nodes[c],g.nodes[c].instances.length-1);return a};b.state_machine_set_start_node=E;b.state_machine_get_state=x;b.state_machine_get_state_id=function(a,b){var c=a.instances[b].current_node;if(c)return c.id};b.machine_state_get_allowed_transition=function(a,b){var c=x(a,b);if(c)return c.allowed_ids};b.state_machine_switch_state=function(a,b,c){if(a.lock)return v&&console.log("state machine is locked"),
!1;var f=x(a,c),p=f.id;if(0<=f.allowed_ids.indexOf(b)){var y=!0;f.call_before_switch&&(y=f.call_before_switch(p,b,f,null,c));if(y)return y=p==b,E(a,b,c),a=x(a,c),f.call_after_switch&&f.call_after_switch(p,b,f,a,c),f.call_switch_from&&f.call_switch_from(y,!0,p,b,f,a,c),a.call_switch_to&&a.call_switch_to(y,!1,p,b,f,a,c),!0;v&&console.log("blocked by callback")}else v&&console.log("transition is not allowed: "+p+"->"+b);return!1}});b4w.register("petigor_states",function(b,a){function E(t,R){var m=S,a=J,b=T;u.get_rotation(t,b);u.get_translation(t,m);l.transformQuat(z.AXIS_MY,b,a);l.normalize(a,a);l.normalize(a,a);l.scaleAndAdd(m,a,k.speed*R,m);C.append_ray_test_ext(t,[0,0,.5],[0,0,-1],"raytest_floor",function(a,R,b,c,l,W){m[2]=l[2];u.set_translation_v(t,m)},!0,!1,!0,!0);u.set_translation_v(t,m)}function x(t,a,m){var b=A,c=T,d=U;u.get_rotation(t,c);l.transformQuat(z.AXIS_MY,c,b);a[2]=0;l.normalize(a,a);G.rotationTo(b,a,d);G.multiply(d,
c,d);a=l.dot(b,a);a=Math.acos(1<a?1:-1>a?-1:a);b=Math.abs(a)/Math.PI*2/3;G.slerp(c,d,Math.min(m/b*k.speed,1),d);u.set_rotation_v(t,d);return a}function v(t){var a=t.payload.anim_obj,m=t.payload.anim;t=t.instances[k.ro_sm_node_state.instance_id];for(var b=0;b<m.length;b++){var c=t.anim[m.name];c||(c=m[b].slot);e.play(a,null,c)}}function g(a,b){for(var m=a.payload.anim_obj,c=a.payload.anim,d=a.instances[k.ro_sm_node_state.instance_id],l=0;l<c.length;l++){var h=d.anim[c.name];h||(h=c[l].slot);b||e.set_frame(m,
0,h);e.stop(m,h)}}function M(a,b,m){var c=k.ro_sm_node_state.node;m=c.instances[k.ro_sm_node_state.instance_id];if(!m.pause)if(v(c),a=d.get_sensor_value(a,b,0),c=new Float32Array(3),b=m.path,u.get_translation(k.character,c),b)if(m.path_point_index>=b.length)k.dest_rotation?(m=k.character,b=V,l.transformQuat(z.AXIS_MY,k.dest_rotation,b),m=x(m,b,a),Math.abs(m)<.05*Math.PI&&w(1)):w(1);else if(b&&b.length&&b[m.path_point_index]){l.subtract(c,b[m.path_point_index],A);A[2]=0;var c=l.len(A),h;h=k.character;
var f=b[m.path_point_index],e=S,g=J;u.get_translation(h,e);l.subtract(f,e,g);h=x(h,g,a);Math.abs(h)<Math.PI/4&&c>=k.dist_err||c<k.dist_err&&.02<c&&m.path_point_index==b.length-1?E(k.character,a):Math.abs(h)<.1*Math.PI&&(m.path_point_index++,m.path_point_index>=b.length&&!k.dest_rotation&&w(1))}else w(1);else w(1)}function c(a,b,c,l){a.instances[b].action={speakers:null,manifold_name:c,callback:l};b=a.instances[b];b.action.speakers=[];a=a.payload.sound;for(var d in a)b.action.speakers.push(N.get_object_by_name(a[d].name))}
function f(a,b){var c=a.instances[b];if(c.action){var l=c.action.speakers,h=c.action.manifold_name,e=a.payload.anim_obj,f;for(f in c.speakers)D.stop(l[f]);g(a);h&&d.check_sensor_manifold(e,h)&&d.remove_sensor_manifold(e,h)}}function p(a,b){var c=a.instances[b];if(c.action){var l=c.action.speakers,h=c.action.manifold_name,f=c.action.callback,g=a.payload.anim_obj;if(!c.pause){var n=a.payload.anim_obj,L=a.instances[k.ro_sm_node_state.instance_id];L.anim={};for(var p=0;p<a.payload.anim.length;p++){var q=
a.payload.anim[p],r=e.get_slot_num_by_anim(n,q.name);0>r&&(r=q.slot,L.anim[q.name]=r,e.apply(n,q.name,r));e.set_behavior(n,q.flags,r)}n=d.create_elapsed_sensor();h&&f&&d.create_sensor_manifold(g,h,d.CT_CONTINUOUS,[n],null,f)}for(var u in l)D.play(l[u]);v(a);c.pause=!1}}function y(a,b){c(a,b,"moving",M)}function F(a,b,c,l,h,d,e){if(a){if(a=h.instances[e],a.action){b=a.action.speakers;for(var k in a.speakers)D.pause(b[k]);g(h,!0);a.pause=!0}}else f(h,e)}function I(a,b,c,l,d,e,f){b=e.instances[f];u.get_translation(k.character,
k.source);u.get_tsr(k.navmesh_obj,O);h.invert(O,P);h.transform_vec3(k.source,P,A);h.transform_vec3(k.destination,P,J);a=C.navmesh_get_island(k.navmesh_obj,A);if((a=C.navmesh_find_path(k.navmesh_obj,A,J,a))&&a.length){b.path_point_index=1;a=[A].concat(a);b.path=a;b=new Float32Array(3*a.length);for(c=0;c<a.length;c++)h.transform_vec3(a[c],O,a[c]),b[3*c]=a[c][0],b[3*c+1]=a[c][1],b[3*c+2]=a[c][2]+.18;k.positions=b}else b.path_point_index=0;p(e,f,!0)}function B(a,b){c(a,b,"standing")}function Q(a,b,c,
h,l,d,e){a||f(l,e)}function H(a,b,c,l,h,d,e){p(d,e)}function n(a,b,c,l,h){k.ro_sm_node_state={node:l,instance_id:h}}function w(a){return q.state_machine_switch_state(r,a,K)}var e=a("animation"),u=a("transform"),q=a("state_machine"),D=a("sfx"),z=a("util"),d=a("controls"),G=a("quat"),C=a("physics"),N=a("scenes"),l=a("vec3"),h=a("tsr"),L="START STANDING WAITING MOVING MOVING_TO_TARGET INTERACTING".split(" "),S=new Float32Array(3),A=new Float32Array(3),J=new Float32Array(3),V=new Float32Array(3),T=new Float32Array(4),
U=new Float32Array(4);b.state_id_by_name=function(a){return L.indexOf(a)};b.STANDING=1;b.WAITING=2;b.MOVING=3;b.MOVING_TO_TARGET=4;b.INTERACTING=5;var r=null,K=null,k=null,O=h.create(),P=h.create();b.init=function(a){if(r)throw"It's a singleton!!!";k=a;r=q.state_machine_create();q.state_machine_add_state(r,0,[1],null,n);q.state_machine_add_state(r,1,[1,2,3,5,4],null,n,Q,H,B,{anim_obj:k.character_armature,anim:[{slot:e.SLOT_0,name:"petigor_quest_idle",flags:e.AB_CYCLIC}],sound:[]});q.state_machine_add_state(r,
2,[1,2,3,5,4],null,n,n,n,null,{anim_obj:k.character_armature,anim:[{slot:e.SLOT_0,name:"pestel_throwing",flags:e.AB_CYCLIC}],sound:[{name:"voice"}]});q.state_machine_add_state(r,3,[1,3,4],null,n,F,I,y,{anim_obj:k.character_armature,anim:[{slot:e.SLOT_0,name:"petigor_quest_walk",flags:e.AB_CYCLIC}],sound:[]});q.state_machine_add_state(r,4,[1],null,n,F,I,y,{anim_obj:k.character_armature,anim:[{slot:e.SLOT_0,name:"petigor_quest_walk",flags:e.AB_CYCLIC}],sound:[]});q.state_machine_add_state(r,5,[1,5],
null,n,null,null,null,{});q.state_machine_validate(r);K=q.state_machine_create_instance(r);q.state_machine_set_start_node(r,0,K);w(5)};b.get_state=function(){return q.state_machine_get_state_id(r,K)};b.switch_state=w});if(b4w.module_check("quest"))throw"Failed to register module: quest";
b4w.register("quest",function(b,a){function E(a,b){b?(document.getElementById("preloader_cont").style.visibility="visible",B.set("srgb_type","SRGB_PROPER"),I.load(G+"quest/main_scene_quest.json",p,x,!0)):m_print.log("b4w init failure")}function x(a){var b=document.getElementById("prelod_dynamic_path"),c=b.nextElementSibling;b.style.width=a+"%";c.innerHTML=a+"%";100==a&&v()}function v(){var a=document.getElementById("preloader_cont");setTimeout(function(){a.style.visibility="hidden"},1E3)}function g(a,
b){C||(d.destination=new Float32Array(3),d.source=new Float32Array(3),z.get_translation(d.character,d.source),z.get_translation(a[0],d.destination),d.dest_rotation=new Float32Array(4),z.get_rotation(a[0],d.dest_rotation),n.switch_state(n.MOVING_TO_TARGET),C=!0);return n.get_state()!=n.MOVING_TO_TARGET?(C=!1,d.dest_rotation=null,n.switch_state(n.STANDING),!1):!0}function M(a,b){var c=n.state_id_by_name(a[0]);0<=c?n.switch_state(c):console.log("Bad state, please check the name")}function c(a,b){d.speed=
a[0]}function f(a,b,c){a=e.get_sensor_payload(a,b,0);d.destination=new Float32Array(3);d.source=new Float32Array(3);D.copy(a.hit_pos,d.destination);z.get_translation(d.character,d.source);n.switch_state(n.MOVING);e.check_sensor_manifold(null,"ray_test")&&e.remove_sensor_manifold(null,"ray_test")}function p(a,b){F.enable_camera_controls();d.character=w.get_object_by_name("petigor_quest");d.character_armature=w.get_object_by_dupli_name("petigor_quest","petigor_armature_quest");d.navmesh_obj=w.get_object_by_name("navmesh");
H.append_custom_callback("switch_state",M);H.append_custom_callback("move_to_target",g);H.append_custom_callback("set_variables",c);n.init(d);var f=e.create_mouse_click_sensor(),p=e.create_touch_click_sensor();e.create_sensor_manifold(null,"click",e.CT_SHOT,[f,p],e.default_OR_logic_fun,N)}var y=a("main"),F=a("app"),I=a("data"),B=a("config"),Q=a("version"),H=a("logic_nodes"),n=a("petigor_states"),w=a("scenes"),e=a("controls"),u=a("camera"),q=a("math"),D=a("vec3"),z=a("transform");a("tsr");a("geometry");
a("material");var d={character:void 0,character_armature:void 0,navmesh:void 0,navmesh_obj:void 0,source:new Float32Array(3),click:!1,speed:1,dist_err:.5},G=B.get_std_assets_path()+"petigors_tale/",C=!1,N=function(a,b,c){c=e.get_sensor_payload(a,b,0).coords;c[0]&&c[1]||(c=e.get_sensor_payload(a,b,1).coords);b=q.create_pline();d.to||(d.to=new Float32Array(3),d.from=new Float32Array(3));a=w.get_active_camera();u.calc_ray(a,c[0],c[1],b);q.get_pline_directional_vec(b,d.to);D.scale(d.to,1E3,d.to);D.copy([0,
0,0],d.from);e.check_sensor_manifold(null,"ray_test")&&e.remove_sensor_manifold(null,"ray_test");c=[];b=["raytest_floor","ray_protect"];for(var g=0;g<b.length;g++)c.push(e.create_ray_sensor(a,d.from,d.to,b[g],!1,!0,!0));e.create_sensor_manifold(null,"ray_test",e.CT_SHOT,c,function(a){for(var b=!1,c=1;c<a.length;c++)b=b||a[c];return a[0]&&!b},f)};b.init=function(){var a=y.detect_mobile(),b="DEBUG"==Q.type();F.init({canvas_container_id:"canvas3d",callback:E,quality:B.P_HIGH,physics_enabled:!0,console_verbose:!0,
alpha:!1,physics_use_workers:!a,assets_dds_available:!b,assets_pvr_available:!b,assets_min50_available:!b,show_fps:b,autoresize:!0})}});b4w.require("quest").init("en");
