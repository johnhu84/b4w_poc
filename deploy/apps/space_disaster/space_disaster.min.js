b4w.register("space_disaster",function(ka,f){function la(b,a){a?(Y.create_preloader(),ma.load(na+"space_disaster.json",oa,pa)):console.log("b4w init failure")}function pa(b){Y.update_preloader(b)}function qa(b,a){for(var u=""+b;u.length<a;)u="0"+u;return u}function oa(b){ra();G.check_browser_support()&&sa();ta(G.check_browser_support());ua();va(G.check_browser_support());wa();xa();ya();Z();b=k.get_object_by_name("sundtrack_entrance");var a=k.get_object_by_name("sundtrack_loop_A");z.play(b,0,0);z.play(a,
69,0)}function va(d){za.update();for(var a=function(c,a,n){var g=b.get_sensor_value(c,a,0),u=b.get_sensor_value(c,a,1),x=b.get_sensor_value(c,a,2),h=b.get_sensor_value(c,a,3),k=b.get_sensor_value(c,a,4),l=b.get_sensor_value(c,a,5),P=b.get_sensor_value(c,a,6),Q=b.get_sensor_value(c,a,7),R=b.get_sensor_value(c,a,8),f=b.get_sensor_value(c,a,9);n=b.get_sensor_value(c,a,10);var p=b.get_sensor_value(c,a,11),e=b.get_sensor_value(c,a,12),t=b.get_sensor_value(c,a,13);a=.2*e;var r=K.get_velocities(c,ba);g&&
(m+=5*r.trans*e);x&&(m-=5*r.trans*e);h&&(q-=5*r.trans*e);u&&(q+=5*r.trans*e);(k||l||P||Q)&&ca(t);d||(q-=5*r.trans*e*R,m+=5*r.trans*e*f,g=K.get_camera_angles(c,Aa)[1]-p*a,K.eye_rotate(c,-n*a,g,!1,!0))},u=function(c){var d=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_12,c),n=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_15,c),g=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_13,c),u=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_14,c),x=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_4,c),h=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_5,
c),l=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_6,c),e=b.create_gamepad_btn_sensor(r.GMPD_BUTTON_7,c),P=b.create_gamepad_axis_sensor(r.GMPD_AXIS_0,c),Q=b.create_gamepad_axis_sensor(r.GMPD_AXIS_1,c),R=b.create_gamepad_axis_sensor(r.GMPD_AXIS_2,c),f=b.create_gamepad_axis_sensor(r.GMPD_AXIS_3,c),p=b.create_elapsed_sensor(),m=b.create_timeline_sensor(),q=k.get_active_camera();b.create_sensor_manifold(q,"CONTROLLER_CAMERA_MOVE"+c,b.CT_CONTINUOUS,[d,n,g,u,x,h,l,e,P,Q,R,f,p,m],function(){return!0},a)},x=
0;4>x;x++)u(x)}function ta(d){if(!d){var a=da.get_canvas();a.addEventListener("mouseup",function(b){Ba.request_pointerlock(a)},!1)}var u=!1;da.get_container().addEventListener("click",function(b){r.request_fullscreen_hmd();u=!0});d=b.create_timeline_sensor();b.create_sensor_manifold(null,"MOUSE_SHOOT",b.CT_POSITIVE,[d],null,function(a,c,d){u&&(a=b.get_sensor_value(a,c,0),ca(a),u=!1)})}function ua(){var d=b.create_keyboard_sensor(b.KEY_W),a=b.create_keyboard_sensor(b.KEY_S),u=b.create_keyboard_sensor(b.KEY_A),
h=b.create_keyboard_sensor(b.KEY_D),c=function(a,c,d,n){if(1==d)switch(d=b.get_sensor_value(a,c,0),a=K.get_velocities(a,ba),c){case "LEFT":q-=5*a.trans*d;break;case "RIGHT":q+=5*a.trans*d;break;case "UP":m+=5*a.trans*d;break;case "DOWN":m-=5*a.trans*d}},C=b.create_elapsed_sensor(),n=k.get_active_camera();b.create_sensor_manifold(n,"LEFT",b.CT_CONTINUOUS,[C,u],null,c);b.create_sensor_manifold(n,"RIGHT",b.CT_CONTINUOUS,[C,h],null,c);b.create_sensor_manifold(n,"UP",b.CT_CONTINUOUS,[C,d],null,c);b.create_sensor_manifold(n,
"DOWN",b.CT_CONTINUOUS,[C,a],null,c)}function Ca(){var b=l.cockpit_empty,a=v;a[0]=0;a[1]=0;a[2]=0;h.set_translation_v(b,a);b=k.get_active_camera();h.set_translation_v(b,a);(b=l.camera_asteroids_obj)&&h.set_translation_v(b,a);(b=l.environment_empty)&&h.set_translation_v(b,a);m=q=0;l.hp=100;(a=l.cockpit_mesh_obj)&&S.set_nodemat_value(a,["screen","life"],.19)}function ra(){l={cockpit_empty:k.get_object_by_name("cockpit"),cockpit_mesh_obj:k.get_object_by_dupli_name("cockpit","cockpit"),camera_asteroids_obj:k.get_object_by_name("Camera_asteroids"),
laser_obj:k.get_object_by_dupli_name("cockpit","laser"),laser_arm:k.get_object_by_dupli_name("cockpit","laser_arm"),lighting:k.get_object_by_name("lighting"),cockpit_light:k.get_object_by_name("cockpit_light"),speaker_strike:k.get_object_by_dupli_name("cockpit","speaker_laser_strike"),speaker_alarm:k.get_object_by_dupli_name("cockpit","speaker_alarm"),speaker_ast_hit:k.get_object_by_dupli_name("cockpit","asteroid_hit"),crosshair_obj:k.get_object_by_name("crosshair"),crosshair_base_obj:k.get_object_by_name("crosshair_base"),
environment_empty:k.get_object_by_name("environment"),environment_tunnel_obj:k.get_object_by_dupli_name("environment","Circle"),environment_sphere_obj:k.get_object_by_dupli_name("environment","Sphere"),environment_arm:k.get_object_by_dupli_name("environment","environment_arm"),hp:100};var d=l.cockpit_empty,a=l.cockpit_mesh_obj,u=l.camera_asteroids_obj,x=l.laser_arm,c=l.crosshair_obj,C=l.environment_empty,n=l.environment_arm;if(d&&C){var g=L.get_bone_tsr(n,"move",A.create()),e=b.create_elapsed_sensor();
b.create_sensor_manifold(d,"COCKPIT_TRANSLATION",b.CT_POSITIVE,[e],null,function(a,c,d){if(1E-4<Math.abs(q)||1E-4<Math.abs(m)){d=b.get_sensor_value(a,c,0);c=y.smooth(q,0,d,1);var e=y.smooth(m,0,d,1);q-=c;m-=e;d=h.get_translation(a,v);d[0]+=c;d[2]+=e;h.set_translation_v(a,d);c=k.get_active_camera();h.set_translation_v(c,d);h.set_translation_v(u,d);d[0]-=q/2;d[2]-=m/2;h.set_translation_v(C,d);c=y.clamp(.0625*q,.0625*-Math.PI,.0625*Math.PI);d=t.setAxisAngle(y.AXIS_Y,c,w);e=-y.clamp(.0625*m,.0625*-Math.PI,
.0625*Math.PI)/4;e=t.setAxisAngle(y.AXIS_MX,e,H);d=t.multiply(d,e,w);h.set_rotation_v(a,d);if(a=l.environment_sphere_obj)d=h.get_rotation(a,w),e=y.clamp(.0625*m,.0625*-Math.PI,.0625*Math.PI)*ea,e=t.setAxisAngle(y.AXIS_MX,e,H),e=t.multiply(d,e,w),c=t.setAxisAngle(y.AXIS_MZ,-c*ea,H),e=t.multiply(d,c,w),h.set_rotation_v(a,e);a=A.get_trans_view(g);a=p.copy(a,v);a[0]+=q;a[2]+=m;c=A.copy(g,I);c=A.set_trans(a,c);L.set_bone_tsr(n,"move",c)}})}l.environment_tunnel_obj&&(e=b.create_elapsed_sensor());x&&c&&
(e=b.create_elapsed_sensor(),b.create_sensor_manifold(x,"LASER_ARM",b.CT_CONTINUOUS,[e],null,function(b,a,d){b=h.get_rotation(c,w);b=p.transformQuat(y.AXIS_MZ,b,v);b=p.scale(b,100,v);a=h.get_rotation(x,w);a=t.invert(a,w);b=p.transformQuat(b,a,v);a=A.identity(I);45>b[0]&&(a=A.set_trans(b,I));L.set_bone_tsr(x,"left_laser",a);a=A.identity(I);-45<b[0]&&(a=A.set_trans(b,I));L.set_bone_tsr(x,"right_laser",a)}));if(c){var f=k.get_active_camera(),e=b.create_elapsed_sensor();b.create_sensor_manifold(c,"CROSSHAIR",
b.CT_CONTINUOUS,[e],null,function(a,c,d){d=h.get_translation(f,v);h.set_translation_v(a,d);d=h.get_rotation(f,w);var n=h.get_rotation(a,H);c=b.get_sensor_value(a,c,0);c=t.lerp(n,d,5*c,w);h.set_rotation_v(a,c)})}d=Boolean(navigator.getUserMedia)?navigator.getUserMedia.bind(navigator):Boolean(navigator.webkitGetUserMedia)?navigator.webkitGetUserMedia.bind(navigator):Boolean(navigator.mozGetUserMedia)?navigator.mozGetUserMedia.bind(navigator):Boolean(navigator.msGetUserMedia)?navigator.msGetUserMedia.bind(navigator):
null;if(a&&Boolean(d)){var e=function(b){var c=document.createElement("video");c.setAttribute("autoplay","true");c.src=window.URL.createObjectURL(b);var d=fa.get_canvas_ctx(a,"camera_01");if(d){var n=function(){d.drawImage(c,0,0,c.videoWidth,c.videoHeight,0,0,d.canvas.width,d.canvas.height);fa.update_canvas_ctx(a,"camera_01");setTimeout(function(){n()},Da)};c.onloadedmetadata=function(b){n()}}},aa=function(){T.warn("Web-camera is not avaliable. Please check web-camera connection and allow access to the web-camera.")};
try{var O={video:{width:1280,height:720}};d(O,e,aa)}catch(r){O={video:{mandatory:{maxWidth:1024,maxHeight:768,minWidth:1024,minHeight:768}}},d(O,e,aa)}}}function ya(){var d=k.get_active_camera();if(d){var a=b.create_timeline_sensor();b.create_sensor_manifold(d,"SHAKE_COCKPIT",b.CT_CONTINUOUS,[a,U],null,function(a,d,c){a=b.get_sensor_value(a,d,0);1>a-M?(q+=(Math.random()-.5)*(1-(a-M)/1),m+=(Math.random()-.5)*(1-(a-M)/1)):b.set_custom_sensor(U,0)})}}function sa(){Ea.update();G.enable_hmd(G.HMD_ALL_AXES_MOUSE_NONE);
var d=b.create_elapsed_sensor(),a=b.create_hmd_position_sensor(),e=!1,h=p.create();p.create();var c=k.get_active_camera();b.create_sensor_manifold(c,"HMD_TRANSLATE_CAMERA",b.CT_CONTINUOUS,[d,a],null,function(a,c,d){0<d&&(a=b.get_sensor_payload(a,c,1),r.get_device_by_type_element(r.DEVICE_HMD),e?(c=p.subtract(a,h,E),p.scale(c,15,c),q+=c[0],m+=c[2],p.copy(a,h)):(p.copy(a,h),e=!0))})}function V(b){for(var a=0;a<B.length;a++)if(B[a].name==b)return B[a]}function wa(){for(var d=0;11>d;d++){var a="asteroid."+
qa(d,3),e=k.get_object_by_name(a);if(e){for(var f=k.get_object_children(e),c=null,l=null,n=null,g=0;g<f.length;g++)W.is_armature(f[g])&&(c=f[g]),"explosion_emitter"==k.get_object_name(f[g])&&(l=f[g]),W.is_speaker(f[g])&&(n=f[g]);for(var f=k.get_object_by_name(a+"_copy"),m=null,q=k.get_object_children(f),g=0;g<q.length;g++)W.is_mesh(q[g])&&(m=q[g]);e={name:a,ast_obj:e,ast_arm:c,ast_copy_obj:f,ast_copy_mesh_obj:m,ast_emitter_obj:l,ast_speaker:n,active:!1,angular_velosity:t.create(),velosity:p.create(),
strength:100,is_destroyed:!1};B.push(e);J(e);c=b.create_elapsed_sensor();b.create_sensor_manifold(e,"UPDATE_ASTEROID"+a,b.CT_CONTINUOUS,[c],null,function(a,c,d){if(a.active){var e=a.ast_obj;d=h.get_translation(e,v);c=b.get_sensor_value(a,c,0);var n=p.scale(a.velosity,c,E);p.add(d,n,d);h.set_translation_v(e,d);c=t.slerp(Fa,a.angular_velosity,c,w);n=h.get_rotation(e,H);c=t.multiply(n,c,w);t.normalize(c,c);h.set_rotation_v(e,c);if(e=a.ast_copy_obj)h.set_translation_v(e,d),h.set_rotation_v(e,c);-20>d[1]&&
J(a)}})}}}function Ga(b){b=k.get_object_name_hierarchy(b)[0];b=V(b);b.is_destroyed=!1;J(b)}function J(b){var a=b.ast_obj,e=v;e[0]=0;e[1]=1E3;e[2]=0;t.identity(w);h.set_translation_v(a,e);(a=b.ast_copy_obj)&&h.set_translation_v(a,e);p.set(0,0,0,b.velosity);t.identity(b.angular_velosity);b.active=!1;b.strength=100}function ca(d){if(1.2<d-ga){b.set_custom_sensor(X,1);var a=l.laser_obj;a&&(e.apply(a,"laser_strike"),e.play(a),e.set_behavior(a,e.AB_FINISH_STOP));ha=ga=d;(d=l.speaker_strike)&&z.play_def(d);
if(d=l.lighting)e.apply(d,"laser_strike_lighting"),e.play(d)}}function xa(){var d=function(a,d,n){b.get_sensor_value(a,d,0)-ha>Ha&&(b.set_custom_sensor(X,0),(n=l.speaker_strike)&&z.is_playing(n)&&z.stop(n));n=h.get_translation(a,v);var g=h.get_rotation(a,w),g=p.transformQuat(y.AXIS_MZ,g,E),g=p.scale(g,100,E),g=p.add(g,n,g),f=b.get_sensor_value(a,d,1);d=Ia.append_ray_test(null,n,g,"crash",function(b,a,c,d){b=c;c=700*f;d=k.get_object_name_hierarchy(b)[0];a=k.get_object_name_hierarchy(b)[1];if((b=V(d))&&
!b.is_destroyed&&(b.strength-=c,0>b.strength)){p.set(0,0,0,b.velosity);t.identity(b.angular_velosity);if(c=b.ast_arm)e.apply(c,a+"_disruption"),e.play(c,Ga);if(a=b.ast_copy_mesh_obj)e.apply(a,"asteroid_fading"),e.play(a);if(a=l.lighting)e.apply(a,"asteroid_burst"),e.play(a);if(c=b.ast_emitter_obj)a=h.get_translation(b.ast_obj,v),h.set_translation_v(c,a),e.apply(c,"explosion"),e.play(c);if(c=b.ast_speaker)a=h.get_translation(b.ast_obj,v),h.set_translation_v(c,a),z.play_def(c);b.is_destroyed=!0}},!0)},
a=l.crosshair_obj;if(a){var f=b.create_timeline_sensor(),m=b.create_elapsed_sensor();b.create_sensor_manifold(a,"BURST",b.CT_POSITIVE,[f,m,X],null,d)}}function Z(){T.log("START GAME.");Ca();var d=b.create_timeline_sensor(),a=k.get_active_camera();b.create_sensor_manifold(a,"ASTEROID_SPAWN",b.CT_POSITIVE,[d],null,function(a,d,e){d=b.get_sensor_value(a,d,0);if(d-ia>F)for(var g=0;g<B.length;g++)if(e=B[g],!e.active){g=h.get_translation(a,v);a=e;a.active=!0;e=p.copy(g,E);e[0]+=3*(2*Math.random()-1);e[1]=
0;e[2]+=3*(2*Math.random()-1);g=p.copy(g,v);g[0]+=20*(2*Math.random()-1);g[1]=100;g[2]+=20*Math.random()/2;h.set_translation_v(a.ast_obj,g);var f=a.ast_copy_obj;f&&h.set_translation_v(f,g);e=p.subtract(e,g,E);p.normalize(e,e);e=p.scale(e,D,e);D=40>D?D+1:D;(g=l.cockpit_mesh_obj)&&S.set_nodemat_value(g,["screen","speed"],1-(D-20)/20*8%8*.1);p.copy(e,a.velosity);e=p.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1,v);a.angular_velosity=t.setAxisAngle(e,Math.PI*(2*Math.random()-1)*10,a.angular_velosity);
ia=d;F=.2<F?F-.03:F;break}});var f=b.create_collision_sensor(a,"crash",!1),m=0;b.create_sensor_manifold(a,"CRASH",b.CT_CONTINUOUS,[f,d],null,function(c,d,f){f=b.get_sensor_value(c,d,1);if(!(1>f-m)){m=f;l.hp-=12.4;var g=l.cockpit_mesh_obj;g&&S.set_nodemat_value(g,["screen","life"],1-.8*l.hp/100);if(0<l.hp){if(c=b.get_sensor_payload(c,d,0).coll_obj){g&&(e.apply(g,"cockpit_shader_alarm",e.SLOT_0),e.apply(g,"screen_shader_alarm",e.SLOT_1),e.play(g,null,e.SLOT_ALL));if(d=l.cockpit_light)e.apply(d,"cockpit_light_alarm"),
e.play(d);if(d=l.speaker_alarm)z.is_playing(d)&&z.stop(d),z.play_def(d);(d=l.speaker_ast_hit)&&z.play_def(d);c=k.get_object_name_hierarchy(c)[0];(c=V(c))&&J(c);b.set_custom_sensor(U,1);M=f}}else{T.log("PLAYERS HP IS LESS 0. RESTART GAME.");for(f=0;f<B.length;f++)J(B[f]);D=20;F=2;b.remove_sensor_manifold(a,"CRASH");b.remove_sensor_manifold(a,"ASTEROID_SPAWN");Z()}}})}var ja=f("app"),e=f("animation"),L=f("armature"),K=f("camera"),Ja=f("config"),da=f("container"),b=f("controls"),ma=f("data"),za=f("gp_conf"),
G=f("hmd"),Ea=f("hmd_conf"),r=f("input"),Ba=f("mouse"),t=f("quat"),W=f("objects"),Y=f("preloader"),T=f("print"),Ia=f("physics"),k=f("scenes"),z=f("sfx"),fa=f("textures"),h=f("transform"),A=f("tsr"),p=f("vec3"),Ka=f("version"),y=f("util"),S=f("material"),w=t.create(),H=t.create(),Aa=new Float32Array(2),v=p.create(),E=p.create(),I=A.create(),Fa=new Float32Array([0,0,0,1]),Da=1E3/24,Ha=5/6,ea=1/512,F=2,ia=0,D=20,l=null,B=[],ba={},q=0,m=0,M=0,ga=0,ha=0,X=b.create_custom_sensor(0),U=b.create_custom_sensor(0),
N="DEBUG"===Ka.type(),na=Ja.get_std_assets_path()+"space_disaster/";ka.init=function(){var b=N,a=ja.get_url_params();a&&"show_fps"in a&&(b=!0);ja.init({canvas_container_id:"main_canvas_container",callback:la,console_verbose:!0,show_fps:b,assets_dds_available:!N,assets_pvr_available:!N,assets_min50_available:!N,autoresize:!0,stereo:"HMD"})}});b4w.require("space_disaster").init();
